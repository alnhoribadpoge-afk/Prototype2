<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Taguig National High School</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', sans-serif; }
    
    .page { display: none; }  
    .page.active { display: block; }
    
    .navbar {
      background: #b30000;
      padding: 15px 0;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    .nav-container {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 20px;
    }
    .logo {
      display: flex;
      align-items: center;
      gap: 15px;
      color: white;
      text-decoration: none;
      cursor: pointer;
    }
    .logo-circle {
      width: 50px;
      height: 50px;
      background: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    .logo-circle img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .logo-text {
      font-size: 20px;
      font-weight: bold;
    }
    .nav-menu {
      display: flex;
      list-style: none;
      gap: 30px;
    }
    .nav-menu a {
      color: white;
      text-decoration: none;
      font-weight: 500;
      transition: opacity 0.3s;
      cursor: pointer;
    }
    .nav-menu a:hover { opacity: 0.8; }
    
    .admin-badge {
      background: rgba(255,255,255,0.2);
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 14px;
    }

    .hero {
      height: 500px;
      background: linear-gradient(rgba(179, 0, 0, 0.7), rgba(179, 0, 0, 0.7)),
                  url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 500"><rect fill="%23228B22" width="1200" height="500"/></svg>');
      background-size: cover;
      background-position: center;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      color: white;
    }
    .hero-content {
      max-width: 800px;
      padding: 0 20px;
    }
    .hero h1 {
      font-size: 48px;
      margin-bottom: 15px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    }
    .hero-meta {
      display: flex;
      gap: 20px;
      justify-content: center;
      font-size: 14px;
      opacity: 0.9;
      margin-top: 15px;
    }
    
    .content-section {
      max-width: 1200px;
      margin: 60px auto;
      padding: 0 20px;
    }
    .admissions-card {
      background: linear-gradient(135deg, #1a5f1a 0%, #2d8b2d 100%);
      border-radius: 12px;
      padding: 60px;
      text-align: center;
      color: white;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      margin-top: -80px;
      position: relative;
    }
    .admissions-logo {
      font-size: 72px;
      font-weight: bold;
      margin-bottom: 10px;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .admissions-logo img {
      width: 150px;
      height: 150px;
      object-fit: contain;
      background: white;
      padding: 15px;
      border-radius: 10px;
    }
    .admissions-card h2 {
      font-size: 42px;
      margin-bottom: 30px;
    }
    .cta-buttons {
      display: flex;
      gap: 20px;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 30px;
    }
    .btn {
      padding: 15px 40px;
      border: none;
      border-radius: 5px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
      transition: 0.3s;
    }
    .btn-primary {
      background: white;
      color: #2d8b2d;
    }
    .btn-primary:hover {
      background: #f0f0f0;
    }
    .btn-secondary {
      background: transparent;
      color: white;
      border: 2px solid white;
    }
    .btn-secondary:hover {
      background: rgba(255,255,255,0.1);
    }
    
    .info-section {
      max-width: 1200px;
      margin: 60px auto;
      padding: 0 20px;
    }
    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 30px;
      margin-top: 40px;
    }
    .info-card {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      transition: 0.3s;
    }
    .info-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 20px rgba(0,0,0,0.15);
    }
    .info-card h3 {
      color: #b30000;
      margin-bottom: 15px;
      font-size: 24px;
    }
    .info-card p {
      color: #666;
      line-height: 1.6;
    }
    
    footer {
      background: #b30000;
      color: white;
      padding: 40px 20px;
      text-align: center;
      margin-top: 60px;
    }
    footer p {
      margin: 10px 0;
    }

    .login-body {
      background: linear-gradient(135deg, #b30000 0%, #8b0000 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .login-container {
      background: white;
      padding: 40px;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      width: 100%;
      max-width: 450px;
    }
    
    .logo-section {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .login-logo {
      width: 80px;
      height: 80px;
      background: white;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 15px;
      overflow: hidden;
      border: 3px solid #b30000;
    }
    
    .login-logo img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .login-container h1 {
      color: #b30000;
      font-size: 28px;
      margin-bottom: 10px;
    }
    
    .subtitle {
      color: #666;
      font-size: 14px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: 500;
    }
    
    input[type="email"],
    input[type="password"],
    input[type="text"],
    input[type="date"],
    select {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
    }
    
    input:focus, select:focus {
      outline: none;
      border-color: #b30000;
    }
    
    .login-btn, .submit-btn {
      width: 100%;
      background: #b30000;
      color: white;
      border: none;
      padding: 14px;
      border-radius: 5px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: 0.3s;
    }
    
    .login-btn:hover, .submit-btn:hover { background: #8b0000; }
    .login-btn:disabled, .submit-btn:disabled { background: #ccc; cursor: not-allowed; }
    
    .back-link {
      text-align: center;
      margin-top: 20px;
    }
    
    .back-link a {
      color: #b30000;
      text-decoration: none;
      cursor: pointer;
    }
    
    .back-link a:hover {
      text-decoration: underline;
    }
    
    .error-message {
      background: #ffebee;
      color: #c62828;
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 15px;
      display: none;
    }

    .signup-body {
      background: #f5f5f5;
      min-height: 100vh;
    }

    .container {
      max-width: 800px;
      margin: 40px auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 40px;
    }

    .container h1 {
      color: #b30000;
      text-align: center;
      margin-bottom: 10px;
      font-size: 32px;
    }

    .section {
      border-top: 2px solid #b30000;
      padding-top: 20px;
      margin-top: 30px;
    }

    .section h3 {
      display: flex;
      align-items: center;
      gap: 10px;
      color: #333;
      margin-bottom: 20px;
      font-size: 18px;
    }

    .required { color: #b30000; }

    input[type="radio"],
    input[type="checkbox"] {
      margin-right: 8px;
    }

    .radio-group {
      display: flex;
      gap: 20px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    #shsOptions, #jhsOptions, #lastSchoolDiv {
      margin-top: 15px;
      display: none;
    }

    .captcha-section {
      background: #f9f9f9;
      padding: 20px;
      border-radius: 8px;
      margin: 30px 0;
    }

    .captcha-group {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
      flex-wrap: wrap;
    }

    #captchaDisplay {
      background: rgba(179, 0, 0, 0.1);
      border: 2px solid #b30000;
      padding: 15px 25px;
      font-size: 24px;
      font-weight: bold;
      letter-spacing: 8px;
      user-select: none;
      border-radius: 5px;
    }

    #captchaInput {
      width: 150px;
      padding: 10px;
      font-size: 16px;
      text-align: center;
    }

    .refresh-btn {
      background: #b30000;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 18px;
    }

    .refresh-btn:hover { background: #8b0000; }

    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }

    .modal-content {
      background-color: white;
      margin: 10% auto;
      padding: 30px;
      border-radius: 10px;
      width: 90%;
      max-width: 500px;
      text-align: center;
    }

    .modal-content h2 {
      color: #228B22;
      margin-bottom: 20px;
    }

    .credentials {
      background: #f0f8f0;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
    }

    .credentials p {
      margin: 10px 0;
      font-size: 16px;
    }

    .credentials strong {
      color: #b30000;
      font-size: 18px;
    }

    .modal-btn {
      background: #228B22;
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
      margin-top: 15px;
    }

    .modal-btn:hover { background: #1a6b1a; }

    .sf1-container {
      max-width: 1400px;
      margin: 40px auto 60px;
      padding: 40px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .sf1-container h1 {
      color: #b30000;
      text-align: center;
      margin-bottom: 10px;
    }

    .sf1-header {
      text-align: center;
      margin-bottom: 40px;
      padding-bottom: 20px;
      border-bottom: 3px solid #b30000;
    }

    .sf1-section {
      background: #f9f9f9;
      padding: 25px;
      border-radius: 8px;
      margin-bottom: 30px;
    }

    .sf1-section h3 {
      color: #b30000;
      margin-bottom: 20px;
      font-size: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #ddd;
    }

    .sf1-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-top: 20px;
    }

    .sf1-grid-2 {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      margin-top: 20px;
    }

    .form-actions {
      display: flex;
      justify-content: space-between;
      margin-top: 40px;
      gap: 20px;
    }

    .btn-save {
      background: #007bff;
      color: white;
      padding: 12px 40px;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: 0.3s;
    }

    .btn-save:hover { background: #0056b3; }

    .btn-back {
      background: #6c757d;
      color: white;
      padding: 12px 40px;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: 0.3s;
    }

    .btn-back:hover { background: #545b62; }

    .success-message {
      background: #d4edda;
      color: #155724;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      margin-bottom: 20px;
      display: none;
    }

    .success-message h2 {
      margin-bottom: 10px;
    }

    .section-notification {
      background: #fff3cd;
      color: #856404;
      padding: 15px;
      border-radius: 8px;
      margin-top: 10px;
      font-weight: bold;
      font-size: 16px;
    }

    .stats-bar {
      background: white;
      padding: 20px;
      margin: 20px auto;
      max-width: 1400px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-around;
      flex-wrap: wrap;
      gap: 20px;
    }

    .stat-item {
      text-align: center;
    }

    .stat-number {
      font-size: 32px;
      font-weight: bold;
      color: #b30000;
    }

    .stat-label {
      color: #666;
      font-size: 14px;
      margin-top: 5px;
    }

    .excel-container {
      max-width: 1400px;
      margin: 40px auto;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    
    .excel-header {
      background: #2d8b2d;
      color: white;
      padding: 30px;
      text-align: center;
    }
    
    .excel-header h1 {
      font-size: 32px;
      margin-bottom: 10px;
    }

    .strand-selector {
      background: white;
      padding: 20px;
      margin: 20px auto;
      max-width: 1400px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      text-align: center;
    }

    .strand-selector select {
      padding: 10px 20px;
      font-size: 16px;
      border-radius: 5px;
      border: 1px solid #ddd;
      min-width: 250px;
    }
    
    .table-wrapper {
      overflow-x: auto;
      padding: 20px;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      border: 2px solid #2d8b2d;
      background: white;
    }
    
    th, td {
      border: 1px solid #d0d0d0;
      padding: 14px 12px;
      text-align: left;
      font-size: 13px;
      line-height: 1.5;
    }
    
    th {
      background: #2d8b2d;
      font-weight: bold;
      color: white;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 16px 12px;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    tr:nth-child(even) {
      background: #f9f9f9;
    }
    
    tr:nth-child(odd) {
      background: white;
    }
    
    tr:hover {
      background: #e8f5e9;
      transition: background-color 0.2s ease;
    }
    
    .row-number {
      background: #f2f2f2;
      font-weight: bold;
      text-align: center;
      width: 50px;
      color: #2d8b2d;
    }

    .btn-delete {
      padding: 5px 15px;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      font-size: 12px;
      font-weight: bold;
      background: #dc3545;
      color: white;
    }

    .btn-delete:hover { background: #c82333; }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 5px;
      margin-top: 10px;
    }

    .btn-edit {
      padding: 5px 15px;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      font-size: 12px;
      font-weight: bold;
      background: #28a745;
      color: white;
      margin-bottom: 5px;
    }

    .btn-edit:hover { background: #218838; }

    .section-modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }

    .section-modal-content {
      background-color: white;
      margin: 10% auto;
      padding: 30px;
      border-radius: 10px;
      width: 90%;
      max-width: 500px;
    }

    .section-modal-content h2 {
      color: #b30000;
      margin-bottom: 20px;
    }

    .section-modal-content .form-group {
      margin-bottom: 20px;
    }

    .section-modal-content select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
    }

    .modal-buttons {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 20px;
    }

    .btn-cancel {
      background: #6c757d;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
    }

    .btn-cancel:hover { background: #545b62; }

    .btn-confirm {
      background: #28a745;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
    }

    .btn-confirm:hover { background: #218838; }

    .sf1-modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      overflow-y: auto;
    }

    .sf1-modal-content {
      background-color: white;
      margin: 30px auto;
      padding: 40px;
      border-radius: 10px;
      width: 90%;
      max-width: 900px;
      max-height: 85vh;
      overflow-y: auto;
    }

    .sf1-modal-content h2 {
      color: #b30000;
      margin-bottom: 10px;
      text-align: center;
    }

    .sf1-modal-header {
      text-align: center;
      padding-bottom: 20px;
      border-bottom: 2px solid #b30000;
      margin-bottom: 30px;
    }

    .sf1-data-section {
      background: #f9f9f9;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .sf1-data-section h4 {
      color: #b30000;
      margin-bottom: 15px;
      font-size: 18px;
      border-bottom: 1px solid #ddd;
      padding-bottom: 8px;
    }

    .sf1-data-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-top: 15px;
    }

    .sf1-data-item {
      display: flex;
      flex-direction: column;
    }

    .sf1-data-label {
      font-weight: bold;
      color: #555;
      font-size: 13px;
      margin-bottom: 5px;
    }

    .sf1-data-value {
      color: #333;
      font-size: 14px;
      padding: 8px;
      background: white;
      border-radius: 4px;
      border: 1px solid #e0e0e0;
    }

    .sf1-modal-close {
      background: #6c757d;
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      display: block;
      margin: 30px auto 0;
      font-size: 16px;
    }

    .sf1-modal-close:hover { background: #545b62; }

    .download-modal {
      display: none;
      position: fixed;
      z-index: 3000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      overflow-y: auto;
    }

    .download-modal-content {
      background-color: white;
      margin: 50px auto;
      padding: 40px;
      border-radius: 10px;
      width: 90%;
      max-width: 800px;
      max-height: 80vh;
      overflow-y: auto;
    }

    .download-modal-content h2 {
      color: #b30000;
      margin-bottom: 10px;
      text-align: center;
    }

    .download-modal-content p {
      text-align: center;
      color: #666;
      margin-bottom: 30px;
    }

    .section-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }

    .section-item {
      background: #f9f9f9;
      border: 2px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      cursor: pointer;
      transition: all 0.3s;
      text-align: center;
    }

    .section-item:hover {
      background: #e8f5e9;
      border-color: #28a745;
      transform: translateY(-2px);
    }

    .section-item.selected {
      background: #28a745;
      border-color: #28a745;
      color: white;
      position: relative;
    }

    .section-item.selected::before {
      content: 'âœ“';
      position: absolute;
      top: 5px;
      right: 10px;
      font-size: 24px;
      font-weight: bold;
      color: white;
    }

    .section-item-title {
      font-weight: bold;
      font-size: 16px;
      margin-bottom: 5px;
    }

    .section-item-count {
      font-size: 14px;
      opacity: 0.8;
    }

    .download-modal-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-top: 30px;
    }

    .btn-download-selected {
      background: #28a745;
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      font-size: 16px;
    }

    .btn-download-selected:hover { background: #218838; }
    .btn-download-selected:disabled { background: #ccc; cursor: not-allowed; }

    .select-all-btn {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      margin-bottom: 20px;
    }

    .select-all-btn:hover { background: #0056b3; }
  </style>
</head>
<body>
  <div id="homePage" class="page active">
    <nav class="navbar">
      <div class="nav-container">
        <div class="logo" onclick="showPage('homePage')">
          <div class="logo-circle"><img src="logo.jpg" alt="TNHS"></div>
          <span class="logo-text">Taguig National High School</span>
        </div>
        <ul class="nav-menu">
          <li><a onclick="showPage('homePage')">Home</a></li>
          <li><a onclick="showPage('signupPage')">Apply Now</a></li>
          <li><a onclick="showPage('loginPage')">Login</a></li>
          <li><a onclick="showPage('adminLoginPage')">Admin</a></li>
        </ul>
      </div>
    </nav>

    <section class="hero">
      <div class="hero-content">
        <h1>Taguig National High School</h1>
        <div class="hero-meta">
          <span>Published February 13, 2023</span>
          <span>Updated September 12, 2025</span>
        </div>
      </div>
    </section>

    <section class="content-section">
      <div class="admissions-card">
        <div class="admissions-logo"><img src="logo.jpg" alt="TNHS"></div>
        <h2>ADMISSIONS</h2>
        <p style="font-size: 18px; margin-bottom: 20px;">
          Welcome to Taguig National High School enrollment system. Start your journey with us today!
        </p>
        <div class="cta-buttons">
          <button class="btn btn-primary" onclick="showPage('signupPage')">Apply for Admission</button>
          <button class="btn btn-secondary" onclick="showPage('loginPage')">Login to Continue</button>
        </div>
      </div>
    </section>

    <section class="info-section">
      <h2 style="text-align: center; color: #b30000; font-size: 36px; margin-bottom: 20px;">Enrollment Process</h2>
      <div class="info-grid">
        <div class="info-card">
          <h3>1. Sign Up</h3>
          <p>Create your account by providing basic information. You'll receive login credentials to proceed with your application.</p>
        </div>
        <div class="info-card">
          <h3>2. Complete SF1 Form</h3>
          <p>Login with your credentials and complete the Student's Enrollment Form (SF1) with detailed student information.</p>
        </div>
        <div class="info-card">
          <h3>3. Submit & Wait</h3>
          <p>After submitting your SF1 form, your section will be automatically assigned and you'll be notified.</p>
        </div>
      </div>
    </section>

    <footer>
      <p>&copy; 2025 Taguig National High School. All Rights Reserved</p>
      <p>Taguig City, Philippines</p>
    </footer>
  </div>

  <div id="loginPage" class="page">
    <div class="login-body">
      <div class="login-container">
        <div class="logo-section">
          <div class="login-logo"><img src="logo.jpg" alt="TNHS"></div>
          <h1>Login</h1>
          <p class="subtitle">Enter your credentials to access SF1 Form</p>
        </div>
        <div class="error-message" id="errorMessage">Invalid email or password.</div>
        <form id="loginForm">
          <div class="form-group">
            <label>Email Address</label>
            <input type="email" id="loginEmail" required>
          </div>
          <div class="form-group">
            <label>Password</label>
            <input type="password" id="loginPassword" required>
          </div>
          <button type="submit" class="login-btn">Login</button>
        </form>
        <div class="back-link">
          <a onclick="showPage('homePage')">Back to Home</a> | 
          <a onclick="showPage('signupPage')">Sign Up</a>
        </div>
      </div>
    </div>
  </div>

  <div id="adminLoginPage" class="page">
    <div class="login-body">
      <div class="login-container">
        <div class="logo-section">
          <div class="login-logo"><img src="logo.jpg" alt="TNHS"></div>
          <h1>Admin Login</h1>
          <p class="subtitle">Access Dashboard</p>
        </div>
        <div class="error-message" id="adminErrorMessage">Invalid credentials</div>
        <form id="adminLoginForm">
          <div class="form-group">
            <label>Username</label>
            <input type="text" id="adminUsername" required>
          </div>
          <div class="form-group">
            <label>Password</label>
            <input type="password" id="adminPassword" required>
          </div>
          <button type="submit" class="login-btn">Login</button>
        </form>
                <div class="back-link">
          <a onclick="showPage('homePage')">Back to Home</a>
        </div>
      </div>
    </div>
  </div>

  <div id="adminDashboard" class="page">
    <nav class="navbar">
      <div class="nav-container">
        <div class="logo">
          <div class="logo-circle"><img src="logo.jpg" alt="TNHS"></div>
          <span class="logo-text">Admin Dashboard</span>
        </div>
        <ul class="nav-menu">
          <li><span class="admin-badge">Admin: <span id="adminNameDisplay"></span></span></li>
          <li><a onclick="logoutAdmin()">Logout</a></li>
        </ul>
      </div>
    </nav>

    <div class="stats-bar">
      <div class="stat-item">
        <div class="stat-number" id="totalStudents">0</div>
        <div class="stat-label">Total Registrations</div>
      </div>
      <div class="stat-item">
        <div class="stat-number" id="jhsCount">0</div>
        <div class="stat-label">Junior High School</div>
      </div>
      <div class="stat-item">
        <div class="stat-number" id="shsCount">0</div>
        <div class="stat-label">Senior High School</div>
      </div>
      <div class="stat-item">
        <div class="stat-number" id="sf1CompletedCount">0</div>
        <div class="stat-label">SF1 Completed</div>
      </div>
      <div class="stat-item">
        <div class="stat-number" id="femaleCount" style="color: #e91e63;">0</div>
        <div class="stat-label">Female Students</div>
      </div>
      <div class="stat-item">
        <div class="stat-number" id="maleCount" style="color: #2196f3;">0</div>
        <div class="stat-label">Male Students</div>
      </div>
    </div>

    <div class="strand-selector">
      <label style="margin-right: 10px; font-weight: bold;">Filter by Grade & Strand:</label>
            <input type="text" id="searchInput" placeholder="ðŸ” Search by Name, Email, ID, or LRN..." style="padding: 10px 15px; border: 1px solid #ddd; border-radius: 5px; width: 300px; margin-right: 20px; font-size: 14px;" onkeyup="filterTable()">
      <select id="strandFilter" onchange="renderAdminTable()">
        <option value="all">All Students</option>
        <option value="jhs">All Junior High School</option>
        
        <optgroup label="Grade 7 - JUNIOR">
          <option value="g7-JUNIOR">All Grade 7 Sections</option>
          <option value="g7-JUNIOR-1">Section 1</option>
          <option value="g7-JUNIOR-2">Section 2</option>
          <option value="g7-JUNIOR-3">Section 3</option>
          <option value="g7-JUNIOR-4">Section 4</option>
          <option value="g7-JUNIOR-5">Section 5</option>
        </optgroup>
        <optgroup label="Grade 8 - JUNIOR">
          <option value="g8-JUNIOR">All Grade 8 Sections</option>
          <option value="g8-JUNIOR-1">Section 1</option>
          <option value="g8-JUNIOR-2">Section 2</option>
          <option value="g8-JUNIOR-3">Section 3</option>
          <option value="g8-JUNIOR-4">Section 4</option>
          <option value="g8-JUNIOR-5">Section 5</option>
        </optgroup>
        <optgroup label="Grade 9 - JUNIOR">
          <option value="g9-JUNIOR">All Grade 9 Sections</option>
          <option value="g9-JUNIOR-1">Section 1</option>
          <option value="g9-JUNIOR-2">Section 2</option>
          <option value="g9-JUNIOR-3">Section 3</option>
          <option value="g9-JUNIOR-4">Section 4</option>
          <option value="g9-JUNIOR-5">Section 5</option>
        </optgroup>
        <optgroup label="Grade 10 - JUNIOR">
          <option value="g10-JUNIOR">All Grade 10 Sections</option>
          <option value="g10-JUNIOR-1">Section 1</option>
          <option value="g10-JUNIOR-2">Section 2</option>
          <option value="g10-JUNIOR-3">Section 3</option>
          <option value="g10-JUNIOR-4">Section 4</option>
          <option value="g10-JUNIOR-5">Section 5</option>
        </optgroup>
        
        <optgroup label="Grade 11 - STEM">
          <option value="g11-STEM">All STEM Sections</option>
          <option value="g11-STEM-A">STEM-A</option>
          <option value="g11-STEM-B">STEM-B</option>
          <option value="g11-STEM-C">STEM-C</option>
          <option value="g11-STEM-D">STEM-D</option>
        </optgroup>
        
        <optgroup label="Grade 11 - ABM">
          <option value="g11-ABM">All ABM Sections</option>
          <option value="g11-ABM-A">ABM-A</option>
          <option value="g11-ABM-B">ABM-B</option>
          <option value="g11-ABM-C">ABM-C</option>
          <option value="g11-ABM-D">ABM-D</option>
        </optgroup>
        
        <optgroup label="Grade 11 - HUMSS">
          <option value="g11-HUMSS">All HUMSS Sections</option>
          <option value="g11-HUMSS-A">HUMSS-A</option>
          <option value="g11-HUMSS-B">HUMSS-B</option>
          <option value="g11-HUMSS-C">HUMSS-C</option>
          <option value="g11-HUMSS-D">HUMSS-D</option>
        </optgroup>
        
        <optgroup label="Grade 11 - GAS">
          <option value="g11-GAS">All GAS Sections</option>
          <option value="g11-GAS-A">GAS-A</option>
          <option value="g11-GAS-B">GAS-B</option>
          <option value="g11-GAS-C">GAS-C</option>
          <option value="g11-GAS-D">GAS-D</option>
        </optgroup>
        
        <optgroup label="Grade 11 - TVL-ICT">
          <option value="g11-TVL-ICT">All TVL-ICT Sections</option>
          <option value="g11-TVL-ICT-A">TVL-ICT-A</option>
          <option value="g11-TVL-ICT-B">TVL-ICT-B</option>
        </optgroup>
        
        <optgroup label="Grade 11 - TVL-HE">
          <option value="g11-TVL-HE">All TVL-HE Sections</option>
          <option value="g11-TVL-HE-A">TVL-HE-A</option>
          <option value="g11-TVL-HE-B">TVL-HE-B</option>
          <option value="g11-TVL-HE-C">TVL-HE-C</option>
          <option value="g11-TVL-HE-D">TVL-HE-D</option>
        </optgroup>
        
        <optgroup label="Grade 11 - TVL-SMAW">
          <option value="g11-TVL-SMAW">All TVL-SMAW Sections</option>
          <option value="g11-TVL-SMAW-A">TVL-SMAW-A</option>
          <option value="g11-TVL-SMAW-B">TVL-SMAW-B</option>
          <option value="g11-TVL-SMAW-C">TVL-SMAW-C</option>
          <option value="g11-TVL-SMAW-D">TVL-SMAW-D</option>
        </optgroup>
        
        <optgroup label="Grade 11 - TVL-AS">
          <option value="g11-TVL-AS">All TVL-AS Sections</option>
          <option value="g11-TVL-AS-A">TVL-AS-A</option>
          <option value="g11-TVL-AS-B">TVL-AS-B</option>
          <option value="g11-TVL-AS-C">TVL-AS-C</option>
          <option value="g11-TVL-AS-D">TVL-AS-D</option>
        </optgroup>
        
        <optgroup label="Grade 12 - STEM">
          <option value="g12-STEM">All STEM Sections</option>
          <option value="g12-STEM-A">STEM-A</option>
          <option value="g12-STEM-B">STEM-B</option>
          <option value="g12-STEM-C">STEM-C</option>
          <option value="g12-STEM-D">STEM-D</option>
        </optgroup>
        
        <optgroup label="Grade 12 - ABM">
          <option value="g12-ABM">All ABM Sections</option>
          <option value="g12-ABM-A">ABM-A</option>
          <option value="g12-ABM-B">ABM-B</option>
          <option value="g12-ABM-C">ABM-C</option>
          <option value="g12-ABM-D">ABM-D</option>
        </optgroup>
        
        <optgroup label="Grade 12 - HUMSS">
          <option value="g12-HUMSS">All HUMSS Sections</option>
          <option value="g12-HUMSS-A">HUMSS-A</option>
          <option value="g12-HUMSS-B">HUMSS-B</option>
          <option value="g12-HUMSS-C">HUMSS-C</option>
          <option value="g12-HUMSS-D">HUMSS-D</option>
        </optgroup>
        
        <optgroup label="Grade 12 - GAS">
          <option value="g12-GAS">All GAS Sections</option>
          <option value="g12-GAS-A">GAS-A</option>
          <option value="g12-GAS-B">GAS-B</option>
          <option value="g12-GAS-C">GAS-C</option>
          <option value="g12-GAS-D">GAS-D</option>
        </optgroup>
        
        <optgroup label="Grade 12 - TVL-ICT">
          <option value="g12-TVL-ICT">All TVL-ICT Sections</option>
          <option value="g12-TVL-ICT-A">TVL-ICT-A</option>
          <option value="g12-TVL-ICT-B">TVL-ICT-B</option>
        </optgroup>
        
        <optgroup label="Grade 12 - TVL-HE">
          <option value="g12-TVL-HE">All TVL-HE Sections</option>
          <option value="g12-TVL-HE-A">TVL-HE-A</option>
          <option value="g12-TVL-HE-B">TVL-HE-B</option>
          <option value="g12-TVL-HE-C">TVL-HE-C</option>
          <option value="g12-TVL-HE-D">TVL-HE-D</option>
        </optgroup>
        
        <optgroup label="Grade 12 - TVL-SMAW">
          <option value="g12-TVL-SMAW">All TVL-SMAW Sections</option>
          <option value="g12-TVL-SMAW-A">TVL-SMAW-A</option>
          <option value="g12-TVL-SMAW-B">TVL-SMAW-B</option>
          <option value="g12-TVL-SMAW-C">TVL-SMAW-C</option>
          <option value="g12-TVL-SMAW-D">TVL-SMAW-D</option>
        </optgroup>
        
        <optgroup label="Grade 12 - TVL-AS">
          <option value="g12-TVL-AS">All TVL-AS Sections</option>
          <option value="g12-TVL-AS-A">TVL-AS-A</option>
          <option value="g12-TVL-AS-B">TVL-AS-B</option>
          <option value="g12-TVL-AS-C">TVL-AS-C</option>
          <option value="g12-TVL-AS-D">TVL-AS-D</option>
        </optgroup>
      </select>
      <button class="btn-save" onclick="openDownloadModal()" style="margin-left: 20px; padding: 10px 30px; background: #28a745;">
        ðŸ“¥ Choose Section to Download
      </button>
    </div>

    <div class="excel-container">
      <div class="excel-header">
        <h1>STUDENT REGISTRATION DATA</h1>
        <p id="tableTitle">All Students</p>
      </div>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Student ID</th>
              <th>LRN</th>
              <th>Name</th>
              <th>Gender</th>
              <th>Grade Level</th>
              <th>Strand</th>
              <th>Section</th>
              <th>Level</th>
              <th>Status</th>
              <th>Email</th>
              <th>Password</th>
              <th>Contact</th>
              <th>SF1 Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="adminTableBody">
            <tr>
              <td colspan="13" style="text-align:center; padding:40px;">No students yet</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="signupPage" class="page">
    <div class="signup-body">
      <div class="navbar">
        <div class="logo" onclick="showPage('homePage')" style="margin-left: 30px;">
          <div class="logo-circle"><img src="logo.jpg" alt="TNHS"></div>
          <span class="logo-text" style="color:white;">Taguig National High School</span>
        </div>
      </div>

      <div class="container">
        <h1>Applicant Sign Up</h1>
        <p class="subtitle" style="text-align: center; color: #666; margin-bottom: 30px;">Please provide accurate details</p>

        <form id="signupForm" onsubmit="handleSignupSubmit(event)">
          <div class="section">
            <h3>Applicant Level</h3>
            <div class="form-group">
              <label><span class="required">*</span> Select Level</label>
              <div class="radio-group">
                <label><input type="radio" name="applicantLevel" value="Junior High School" onchange="toggleLevel()" required> Junior High School</label>
                <label><input type="radio" name="applicantLevel" value="Senior High School" onchange="toggleLevel()"> Senior High School</label>
              </div>
            </div>

            <div id="jhsOptions">
              <div class="form-group">
                <label><span class="required">*</span> Grade Level</label>
                <select id="jhsGrade">
                  <option value="">-- Select Grade --</option>
                  <option value="7">Grade 7</option>
                  <option value="8">Grade 8</option>
                  <option value="9">Grade 9</option>
                  <option value="10">Grade 10</option>
                </select>
              </div>
            </div>

            <div id="shsOptions">
              <div class="form-group">
                <label><span class="required">*</span> Grade Level</label>
                <select id="shsGrade">
                  <option value="">-- Select Grade --</option>
                  <option value="11">Grade 11</option>
                  <option value="12">Grade 12</option>
                </select>
              </div>
              <div class="form-group">
                <label><span class="required">*</span> SHS Strand</label>
                <select id="strand">
                  <option value="">-- Select Strand --</option>
                  <option value="STEM">STEM</option>
                  <option value="ABM">ABM</option>
                  <option value="HUMSS">HUMSS</option>
                  <option value="GAS">GAS</option>
                  <option value="TVL-ICT">TVL-ICT</option>
                  <option value="TVL-HE">TVL-HE</option>
                  <option value="TVL-SMAW">TVL-SMAW</option>
                  <option value="TVL-AS">TVL-AS</option>
                </select>
              </div>
            </div>
          </div>

          <div class="section">
            <h3>Student Status</h3>
            <div class="form-group">
              <label><span class="required">*</span> Are you an old or new student?</label>
              <div class="radio-group">
                <label><input type="radio" name="studentStatus" value="Old Student" onchange="toggleLastSchool()" required> Old Student</label>
                <label><input type="radio" name="studentStatus" value="New Student" onchange="toggleLastSchool()"> New Student</label>
              </div>
            </div>
            <div id="lastSchoolDiv">
              <div class="form-group">
                <label><span class="required">*</span> Last School Attended</label>
                <input type="text" id="lastSchool">
              </div>
            </div>
          </div>

          <div class="section">
            <h3>Personal Information</h3>
            <div class="form-group">
              <label><span class="required">*</span> LRN (Learner Reference Number)</label>
              <input type="text" id="lrn" placeholder="12-digit LRN" maxlength="12" required>
            </div>
            <div class="form-group">
              <label><span class="required">*</span> Given Name</label>
              <input type="text" id="firstName" required>
            </div>
            <div class="form-group">
              <label>Middle Name</label>
              <input type="text" id="middleName">
            </div>
            <div class="form-group">
              <label><span class="required">*</span> Last Name</label>
              <input type="text" id="lastName" required>
            </div>
            <div class="form-group">
              <label><span class="required">*</span> Email Address</label>
              <input type="email" id="email" required>
            </div>
            <div class="form-group">
              <label><span class="required">*</span> Re-enter Email Address</label>
              <input type="email" id="email2" required>
            </div>
            <div class="form-group">
              <label><span class="required">*</span> Contact Number</label>
              <input type="text" id="contact" placeholder="0912345678" maxlength="11" inputmode="numeric" pattern="[0-9]{11}" required>
            </div>
          </div>

          <button type="submit" class="submit-btn">Submit Application</button>
        </form>
      </div>
    </div>
  </div>

  <div id="sf1Page" class="page">
    <nav class="navbar">
      <div class="nav-container">
        <div class="logo">
          <div class="logo-circle"><img src="logo.jpg" alt="TNHS"></div>
          <span class="logo-text">SF1 Form</span>
        </div>
        <ul class="nav-menu">
          <li><a onclick="logout()">Logout</a></li>
        </ul>
      </div>
    </nav>

    <div class="sf1-container">
      <div class="sf1-header">
        <h1>Update Profile</h1>
        <p style="color: #666; margin-top: 10px;">Welcome, <span id="userEmailDisplay"></span></p>
      </div>

      <div class="success-message" id="successMessage">
        <h2>Enrollment Successful!</h2>
        <p>Your SF1 form has been submitted successfully.</p>
        <div class="section-notification" id="sectionDisplay"></div>
      </div>

      <form id="sf1Form">
        <div class="sf1-section">
          <h3>Guardian Information (Optional)</h3>
          <div class="sf1-grid">
            <div class="form-group">
              <label>Last Name</label>
              <input type="text" name="guardianLastName">
            </div>
            <div class="form-group">
              <label>First Name</label>
              <input type="text" name="guardianFirstName">
            </div>
            <div class="form-group">
              <label>Middle Name</label>
              <input type="text" name="guardianMiddleName">
            </div>
          </div>
          <div class="form-group">
            <label>Extension Name</label>
            <input type="text" name="guardianExtension" style="max-width: 300px;">
          </div>
          <div class="form-group">
            <label>Relationship</label>
            <input type="text" name="guardianRelationship" style="max-width: 300px;" placeholder="e.g. Mother, Father, Guardian">
          </div>
          <div class="checkbox-group">
            <input type="checkbox" id="noMiddleNameGuardian">
            <label for="noMiddleNameGuardian">No middle name</label>
          </div>
        </div>

        <div class="sf1-section">
          <h3>Mother's Maiden Name</h3>
          <div class="sf1-grid">
            <div class="form-group">
              <label>Last Name</label>
              <input type="text" name="motherLastName">
            </div>
            <div class="form-group">
              <label>First Name</label>
              <input type="text" name="motherFirstName">
            </div>
            <div class="form-group">
              <label>Middle Name</label>
              <input type="text" name="motherMiddleName">
            </div>
          </div>
          <div class="form-group">
            <label>Extension Name</label>
            <input type="text" name="motherExtension" style="max-width: 300px;">
          </div>
          <div class="checkbox-group">
            <input type="checkbox" id="noMiddleNameMother">
            <label for="noMiddleNameMother">No middle name</label>
          </div>
          <div class="checkbox-group">
            <input type="checkbox" id="noMotherDisclosed">
            <label for="noMotherDisclosed">No mother / Not disclosed</label>
          </div>
        </div>

        <div class="sf1-section">
          <h3>Father Information</h3>
          <div class="sf1-grid">
            <div class="form-group">
              <label>Last Name</label>
              <input type="text" name="fatherLastName">
            </div>
            <div class="form-group">
              <label>First Name</label>
              <input type="text" name="fatherFirstName">
            </div>
            <div class="form-group">
              <label>Middle Name</label>
              <input type="text" name="fatherMiddleName">
            </div>
          </div>
          <div class="form-group">
            <label>Extension Name</label>
            <input type="text" name="fatherExtension" style="max-width: 300px;">
          </div>
          <div class="checkbox-group">
            <input type="checkbox" id="noMiddleNameFather">
            <label for="noMiddleNameFather">No middle name</label>
          </div>
        </div>

        <div class="sf1-section">
          <h3>Personal Information</h3>
          <div class="form-group">
            <label><span class="required">*</span> Gender</label>
            <div class="radio-group">
              <label><input type="radio" name="gender" value="Male" required> Male</label>
              <label><input type="radio" name="gender" value="Female" required> Female</label>
            </div>
          </div>
        </div>

        <div class="sf1-section">
        <h3>Indigenous Peoples</h3>
        <div class="form-group">
        <label>Are you a member of Indigenous Peoples/Indigenous Cultural Communities (IP/ICC)?</label>
        <div class="radio-group">
        <label><input type="radio" name="indigenous" value="Yes" onchange="toggleEthnicityDropdown()"> Yes</label>
        <label><input type="radio" name="indigenous" value="No" checked onchange="toggleEthnicityDropdown()"> No</label>
        </div>
        </div>
          <div class="form-group" id="ethnicityGroup" style="display: none;">
            <label>Select Your Cultural Community</label>
            <div style="display: flex; gap: 10px; align-items: flex-start;">
              <select name="ethnicity" id="ethnicitySelect" style="flex: 1;">
                <option value="">-- Select Cultural Community --</option>
                <option value="Aeta">Aeta</option>
                <option value="Igorot">Igorot</option>
                <option value="Lumad">Lumad</option>
                <option value="Moro">Moro</option>
                <option value="Cordillera">Cordillera</option>
                <option value="Tagalog">Tagalog</option>
                <option value="Cebuano">Cebuano</option>
                <option value="Ilocano">Ilocano</option>
                <option value="Bicolano">Bicolano</option>
                <option value="Waray">Waray</option>
                <option value="Kapampangan">Kapampangan</option>
                <option value="Pangasinan">Pangasinan</option>
                <option value="Maranao">Maranao</option>
                <option value="Tausug">Tausug</option>
                <option value="Sama-Bajau">Sama-Bajau</option>
                <option value="Other">Other (Please Specify)</option>
              </select>
              <button type="button" class="btn-add-custom" onclick="openAddCulturalModal()" style="padding: 12px 20px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; white-space: nowrap;">+ Add Custom</button>
            </div>
          </div>
          <div class="form-group" id="customEthnicityGroup" style="display: none;">
            <label>Please Specify Your Cultural Community</label>
            <input type="text" name="customEthnicity" id="customEthnicity" style="max-width: 400px;" placeholder="Enter your cultural community">
          </div>
        </div>

        <div class="sf1-section">
          <h3>Mother Tongue & Religion</h3>
          <div class="sf1-grid-2">
            <div class="form-group">
              <label>Mother Tongue</label>
              <select name="motherTongue">
                <option value="">-- Select Mother Tongue --</option>
                <option value="Tagalog">Tagalog</option>
                <option value="Cebuano">Cebuano</option>
                <option value="Ilocano">Ilocano</option>
                <option value="Bicolano">Bicolano</option>
                <option value="Waray">Waray</option>
                <option value="Kapampangan">Kapampangan</option>
                <option value="Pangasinan">Pangasinan</option>
                <option value="Maranao">Maranao</option>
                <option value="Tausug">Tausug</option>
                <option value="Ibanag">Ibanag</option>
                <option value="Ivatan">Ivatan</option>
                <option value="Maguindanao">Maguindanao</option>
                <option value="Cuyonon">Cuyonon</option>
                <option value="Romblomanon">Romblomanon</option>
                <option value="Aklanon">Aklanon</option>
                <option value="Kinaray-a">Kinaray-a</option>
                <option value="English">English</option>
                <option value="Other">Other</option>
              </select>
            </div>
            <div class="form-group">
              <label>Religion</label>
              <select name="religion">
                <option value="">-- Select Religion --</option>
                <option value="Catholic">Catholic</option>
                <option value="Protestant">Protestant</option>
                <option value="Islam">Islam</option>
                <option value="Seventh-day Adventist">Seventh-day Adventist</option>
                <option value="Jehovah's Witness">Jehovah's Witness</option>
                <option value="Iglesia ni Cristo">Iglesia ni Cristo</option>
                <option value="Buddhist">Buddhist</option>
                <option value="Hindu">Hindu</option>
                <option value="Jewish">Jewish</option>
                <option value="Atheist">Atheist</option>
                <option value="Agnostic">Agnostic</option>
                <option value="Other">Other</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label>Other Spoken Languages</label>
            <input type="text" name="otherLanguages" style="max-width: 400px;" placeholder="e.g. English, Spanish, Chinese">
          </div>
        </div>

        <div class="sf1-section">
          <h3>Current Residence</h3>
          <div class="sf1-grid">
            <div class="form-group">
              <label>Province</label>
              <select name="currentProvince" onchange="updateCurrentCity()">
                <option value="">-- Select Province --</option>
                <option value="Metro Manila">Metro Manila</option>
                <option value="Calabarzon">Calabarzon</option>
                <option value="Central Luzon">Central Luzon</option>
                <option value="Ilocos Region">Ilocos Region</option>
                <option value="Cagayan Valley">Cagayan Valley</option>
                <option value="Cordillera">Cordillera</option>
                <option value="Bicol Region">Bicol Region</option>
                <option value="Western Visayas">Western Visayas</option>
                <option value="Central Visayas">Central Visayas</option>
                <option value="Eastern Visayas">Eastern Visayas</option>
                <option value="Zamboanga Peninsula">Zamboanga Peninsula</option>
                <option value="Northern Mindanao">Northern Mindanao</option>
                <option value="Davao Region">Davao Region</option>
                <option value="Soccsksargen">Soccsksargen</option>
                <option value="Caraga">Caraga</option>
                <option value="Bangsamoro">Bangsamoro</option>
              </select>
            </div>
            <div class="form-group">
              <label>City/Municipality</label>
              <select name="currentCity" onchange="updateCurrentBarangay()">
                <option value="">-- Select City/Municipality --</option>
              </select>
            </div>
            <div class="form-group">
              <label>Zip Code</label>
              <input type="text" name="currentZip" placeholder="Auto-filled or enter manually" onchange="validateCurrentZip()">
            </div>
          </div>
          <div class="form-group">
            <label>Barangay</label>
            <select name="currentBarangay" onchange="handleCurrentBarangayChange()">
              <option value="">-- Select Barangay --</option>
            </select>
          </div>
        </div>

        <div class="sf1-section">
          <h3>Permanent Residence</h3>
          <div class="checkbox-group" style="margin-bottom: 20px;">
            <input type="checkbox" id="sameAsCurrentAddress" onchange="copyCurrentToPermanent()">
            <label for="sameAsCurrentAddress">Same as current address</label>
          </div>
          <div class="sf1-grid">
            <div class="form-group">
              <label>Province</label>
              <select name="permanentProvince" onchange="updatePermanentCity()">
                <option value="">-- Select Province --</option>
                <option value="Metro Manila">Metro Manila</option>
                <option value="Calabarzon">Calabarzon</option>
                <option value="Central Luzon">Central Luzon</option>
                <option value="Ilocos Region">Ilocos Region</option>
                <option value="Cagayan Valley">Cagayan Valley</option>
                <option value="Cordillera">Cordillera</option>
                <option value="Bicol Region">Bicol Region</option>
                <option value="Western Visayas">Western Visayas</option>
                <option value="Central Visayas">Central Visayas</option>
                <option value="Eastern Visayas">Eastern Visayas</option>
                <option value="Zamboanga Peninsula">Zamboanga Peninsula</option>
                <option value="Northern Mindanao">Northern Mindanao</option>
                <option value="Davao Region">Davao Region</option>
                <option value="Soccsksargen">Soccsksargen</option>
                <option value="Caraga">Caraga</option>
                <option value="Bangsamoro">Bangsamoro</option>
              </select>
            </div>
            <div class="form-group">
              <label>City/Municipality</label>
              <select name="permanentCity" onchange="updatePermanentBarangay()">
                <option value="">-- Select City/Municipality --</option>
              </select>
            </div>
            <div class="form-group">
              <label>Zip Code</label>
              <input type="text" name="permanentZip" placeholder="Auto-filled or enter manually" onchange="validatePermanentZip()">
            </div>
          </div>
          <div class="form-group">
            <label>Barangay</label>
            <select name="permanentBarangay" onchange="updatePermanentZip()">
              <option value="">-- Select Barangay --</option>
            </select>
          </div>
        </div>

        <div class="sf1-section">
          <h3>Country of Citizenship</h3>
          <div class="form-group">
            <input type="text" name="citizenship" style="max-width: 400px;" placeholder="e.g. Philippines">
          </div>
        </div>

        <div class="sf1-section">
          <h3>Conditional Cash Transfer (CCT)</h3>
          <div class="checkbox-group">
            <input type="checkbox" name="isCCT">
            <label>Is this learner CCT recipient?</label>
          </div>
        </div>

        <div class="sf1-section">
          <h3>Special Educational Needs</h3>
          <div class="form-group">
            <label>Does this learner have Educational Needs?</label>
            <div class="radio-group">
              <label><input type="radio" name="specialNeeds" value="Yes" onchange="toggleLSENDropdown()"> Yes</label>
              <label><input type="radio" name="specialNeeds" value="No" checked onchange="toggleLSENDropdown()"> No</label>
            </div>
          </div>
          <div class="form-group" id="lsenClassificationGroup" style="display: none;">
            <label>Classification/Type of Learner Special Educational Needs (LSEN)</label>
            <select name="lsenType" onchange="handleLSENTypeChange()">
              <option value="">-- Select Classification --</option>
              <option value="Autism Spectrum Disorder">Autism Spectrum Disorder</option>
              <option value="Blind/Low Vision">Blind/Low Vision</option>
              <option value="Deaf/Hard of Hearing">Deaf/Hard of Hearing</option>
              <option value="Intellectual Disability">Intellectual Disability</option>
              <option value="Learning Disability">Learning Disability</option>
              <option value="Physical Disability">Physical Disability</option>
              <option value="Psychosocial Disability">Psychosocial Disability</option>
              <option value="Speech/Language Impairment">Speech/Language Impairment</option>
              <option value="Multiple Disabilities">Multiple Disabilities</option>
              <option value="Other">Other (Please Specify)</option>
            </select>
          </div>
          <div class="form-group" id="lsenOtherGroup" style="display: none;">
            <label>Please Specify Other LSEN Classification</label>
            <input type="text" name="lsenTypeOther" style="max-width: 400px;" placeholder="Enter other classification">
          </div>
        </div>

        <div class="sf1-section">
          <h3>Vaccination & Modality</h3>
          <div class="sf1-grid-2">
            <div class="form-group">
              <label>Is the learner vaccinated against COVID-19?</label>
              <div class="radio-group">
                <label><input type="radio" name="vaccinated" value="Yes"> Yes</label>
                <label><input type="radio" name="vaccinated" value="No" checked> No</label>
              </div>
            </div>
            <div class="form-group">
              <label>Actual Modality</label>
              <input type="text" name="modality" placeholder="e.g. Face-to-face, Online, Blended">
            </div>
          </div>
        </div>

        <div class="form-actions">
          <button type="button" class="btn-back" onclick="logout()">Back</button>
          <button type="button" class="btn-save" onclick="showSF1Preview()">Review & Apply</button>
        </div>
      </form>
    </div>
  </div>

  <div id="successModal" class="modal">
    <div class="modal-content">
      <h2>Registration Successful!</h2>
      <p>Please save your login credentials:</p>
      <div class="credentials">
        <p><strong>Email:</strong> <span id="modalEmail"></span></p>
        <p><strong>Password:</strong> <span id="modalPassword"></span></p>
        <p><strong>User ID:</strong> <span id="modalUserId"></span></p>
      </div>
      <p style="color:#b30000; font-weight:bold;">Save these credentials to access SF1 Form</p>
      <button class="modal-btn" onclick="goToLogin()">Proceed to Login</button>
    </div>
  </div>

  <div id="sectionModal" class="section-modal">
    <div class="section-modal-content">
      <h2>Change Student Section</h2>
      <p style="margin-bottom: 20px; color: #666;">
        <strong>Student:</strong> <span id="editStudentName"></span><br>
        <strong>Current Section:</strong> <span id="editCurrentSection"></span>
      </p>
      <div class="form-group">
        <label>Select New Section:</label>
        <select id="newSectionSelect">
          <option value="">-- Select Section --</option>
        </select>
      </div>
      <div class="modal-buttons">
        <button class="btn-cancel" onclick="closeSectionModal()">Cancel</button>
        <button class="btn-confirm" onclick="confirmSectionChange()">Save Changes</button>
      </div>
    </div>
  </div>

  <div id="sf1ViewModal" class="sf1-modal">
    <div class="sf1-modal-content" id="sf1ModalContent">
      <!-- Content will be dynamically generated -->
    </div>
  </div>

  <div id="downloadModal" class="download-modal">
    <div class="download-modal-content">
      <h2>Choose Sections to Download</h2>
      <p>Select one or more sections to download student data</p>
      
      <button class="select-all-btn" onclick="toggleSelectAll()">Select All / Deselect All</button>
      
      <div id="sectionListContainer" class="section-list">
        <!-- Sections will be dynamically generated -->
      </div>
      
      <div class="download-modal-buttons">
        <button class="btn-cancel" onclick="closeDownloadModal()">Cancel</button>
        <button class="btn-download-selected" style="background: #007bff;" onclick="downloadAllData()">
          ðŸ“¥ Download All Data (Single File)
        </button>
        <button class="btn-download-selected" id="downloadBtn" onclick="downloadSelectedSections()" disabled>
          Download Selected (<span id="selectedCount">0</span>)
        </button>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.min.js"></script>
  <script>
    let users = [];
    let currentUser = null;
    let captchaText = '';

    // ===== DATA PERSISTENCE FUNCTIONS =====
    // Save users to localStorage
    function saveUsersToStorage() {
      try {
        localStorage.setItem('tnhs_users', JSON.stringify(users));
        console.log('âœ… Data saved to localStorage');
      } catch (error) {
        console.error('âŒ Error saving to localStorage:', error);
      }
    }

    // Load users from localStorage
    function loadUsersFromStorage() {
      try {
        const storedUsers = localStorage.getItem('tnhs_users');
        if (storedUsers) {
          users = JSON.parse(storedUsers);
          console.log(`âœ… Loaded ${users.length} users from localStorage`);
          return true;
        }
      } catch (error) {
        console.error('âŒ Error loading from localStorage:', error);
      }
      return false;
    }

    // Clear all data from localStorage
    function clearAllData() {
      if (confirm('âš ï¸ Are you sure you want to delete ALL student data? This cannot be undone!')) {
        localStorage.removeItem('tnhs_users');
        users = [];
        console.log('âœ… All data cleared');
        alert('All data has been cleared');
        location.reload();
      }
    }

    // Export data as JSON backup
    function exportDataAsJSON() {
      const dataStr = JSON.stringify(users, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `tnhs_backup_${new Date().toISOString().split('T')[0]}.json`;
      link.click();
      URL.revokeObjectURL(url);
    }

    // Import data from JSON backup
    function importDataFromJSON(file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const importedUsers = JSON.parse(e.target.result);
          if (Array.isArray(importedUsers)) {
            users = importedUsers;
            saveUsersToStorage();
            alert(`âœ… Successfully imported ${importedUsers.length} records`);
            renderAdminTable();
          } else {
            alert('âŒ Invalid file format');
          }
        } catch (error) {
          alert('âŒ Error importing file: ' + error.message);
        }
      };
      reader.readAsText(file);
    }

    // Initialize app - load data on page load
    window.addEventListener('DOMContentLoaded', function() {
      const dataLoaded = loadUsersFromStorage();
      if (!dataLoaded) {
        console.log('No existing data found. Starting fresh.');
      }
    });

    const sectionCapacity = {
      'g7-JUNIOR': { capacity: 5, sections: ['Section 1', 'Section 2', 'Section 3', 'Section 4', 'Section 5'], count: [0, 0, 0, 0, 0] },
      'g8-JUNIOR': { capacity: 5, sections: ['Section 1', 'Section 2', 'Section 3', 'Section 4', 'Section 5'], count: [0, 0, 0, 0, 0] },
      'g9-JUNIOR': { capacity: 5, sections: ['Section 1', 'Section 2', 'Section 3', 'Section 4', 'Section 5'], count: [0, 0, 0, 0, 0] },
      'g10-JUNIOR': { capacity: 5, sections: ['Section 1', 'Section 2', 'Section 3', 'Section 4', 'Section 5'], count: [0, 0, 0, 0, 0] },
      'g11-STEM': { capacity: 4, sections: ['STEM-A', 'STEM-B', 'STEM-C', 'STEM-D'], count: [0, 0, 0, 0] },
      'g11-ABM': { capacity: 4, sections: ['ABM-A', 'ABM-B', 'ABM-C', 'ABM-D'], count: [0, 0, 0, 0] },
      'g11-HUMSS': { capacity: 4, sections: ['HUMSS-A', 'HUMSS-B', 'HUMSS-C', 'HUMSS-D'], count: [0, 0, 0, 0] },
      'g11-GAS': { capacity: 4, sections: ['GAS-A', 'GAS-B', 'GAS-C', 'GAS-D'], count: [0, 0, 0, 0] },
      'g11-TVL-ICT': { capacity: 2, sections: ['TVL-ICT-A', 'TVL-ICT-B'], count: [0, 0] },
      'g11-TVL-HE': { capacity: 4, sections: ['TVL-HE-A', 'TVL-HE-B', 'TVL-HE-C', 'TVL-HE-D'], count: [0, 0, 0, 0] },
      'g11-TVL-SMAW': { capacity: 4, sections: ['TVL-SMAW-A', 'TVL-SMAW-B', 'TVL-SMAW-C', 'TVL-SMAW-D'], count: [0, 0, 0, 0] },
      'g11-TVL-AS': { capacity: 4, sections: ['TVL-AS-A', 'TVL-AS-B', 'TVL-AS-C', 'TVL-AS-D'], count: [0, 0, 0, 0] },
      'g12-STEM': { capacity: 4, sections: ['STEM-A', 'STEM-B', 'STEM-C', 'STEM-D'], count: [0, 0, 0, 0] },
      'g12-ABM': { capacity: 4, sections: ['ABM-A', 'ABM-B', 'ABM-C', 'ABM-D'], count: [0, 0, 0, 0] },
      'g12-HUMSS': { capacity: 4, sections: ['HUMSS-A', 'HUMSS-B', 'HUMSS-C', 'HUMSS-D'], count: [0, 0, 0, 0] },
      'g12-GAS': { capacity: 4, sections: ['GAS-A', 'GAS-B', 'GAS-C', 'GAS-D'], count: [0, 0, 0, 0] },
      'g12-TVL-ICT': { capacity: 2, sections: ['TVL-ICT-A', 'TVL-ICT-B'], count: [0, 0] },
      'g12-TVL-HE': { capacity: 4, sections: ['TVL-HE-A', 'TVL-HE-B', 'TVL-HE-C', 'TVL-HE-D'], count: [0, 0, 0, 0] },
      'g12-TVL-SMAW': { capacity: 4, sections: ['TVL-SMAW-A', 'TVL-SMAW-B', 'TVL-SMAW-C', 'TVL-SMAW-D'], count: [0, 0, 0, 0] },
      'g12-TVL-AS': { capacity: 4, sections: ['TVL-AS-A', 'TVL-AS-B', 'TVL-AS-C', 'TVL-AS-D'], count: [0, 0, 0, 0] }
    };

    function assignSection(gradeLevel, strand) {
      // Randomly assign section based on grade level and strand
      if (strand === 'N/A') {
        // For Junior High School - assign random section from 1-5
        const jhsSections = ['Section 1', 'Section 2', 'Section 3', 'Section 4', 'Section 5'];
        return jhsSections[Math.floor(Math.random() * jhsSections.length)];
      } else {
        // For Senior High School - assign random section based on strand
        const key = `g${gradeLevel}-${strand}`;
        const config = sectionCapacity[key];
        
        if (config && config.sections.length > 0) {
          // Randomly select a section from available sections
          const randomIndex = Math.floor(Math.random() * config.sections.length);
          return config.sections[randomIndex];
        }
        
        return 'Section A'; // Fallback
      }
    }

    // Generate 50 sample students per section
    function generateSampleData() {
      const firstNames = ['Juan', 'Maria', 'Jose', 'Ana', 'Carlos', 'Rosa', 'Miguel', 'Sofia', 'Luis', 'Carmen', 'Diego', 'Isabel', 'Antonio', 'Lucia', 'Francisco', 'Elena', 'Manuel', 'Gabriela', 'Pedro', 'Victoria', 'Ramon', 'Alejandra', 'Javier', 'Valentina', 'Ricardo', 'Martina', 'Sergio', 'Camila', 'Andres', 'Daniela'];
      const lastNames = ['Garcia', 'Rodriguez', 'Martinez', 'Hernandez', 'Lopez', 'Gonzalez', 'Perez', 'Sanchez', 'Ramirez', 'Torres', 'Flores', 'Rivera', 'Cruz', 'Morales', 'Gutierrez', 'Ortiz', 'Jimenez', 'Reyes', 'Diaz', 'Vargas', 'Castillo', 'Romero', 'Herrera', 'Medina', 'Soto', 'Navarro', 'Campos', 'Rojas', 'Vega', 'Salazar'];
      const middleNames = ['de la', 'del', 'de los', 'van', 'von', 'de', 'y', 'e', 'o', ''];
      const genders = ['Male', 'Female'];
      const strands = ['STEM', 'ABM', 'HUMSS', 'GAS', 'TVL-ICT', 'TVL-HE', 'TVL-SMAW', 'TVL-AS'];
      
      let studentCount = 0;
      
      // Generate students for each grade and strand combination
      for (let grade of [11, 12]) {
        for (let strand of strands) {
          const key = `g${grade}-${strand}`;
          const config = sectionCapacity[key];
          
          if (config) {
            // Generate 50 students per section
            for (let section of config.sections) {
              for (let i = 0; i < 50; i++) {
                const firstName = firstNames[Math.floor(Math.random() * firstNames.length)];
                const lastName = lastNames[Math.floor(Math.random() * lastNames.length)];
                const middleName = middleNames[Math.floor(Math.random() * middleNames.length)];
                const gender = genders[Math.floor(Math.random() * genders.length)];
                const lrn = String(Math.floor(Math.random() * 900000000000) + 100000000000).substring(0, 12);
                const userId = 'TNHS' + Date.now() + Math.random().toString(36).substr(2, 9);
                const email = `${firstName.toLowerCase()}.${lastName.toLowerCase()}${studentCount}@tnhs.edu.ph`;
                const contact = '09' + String(Math.floor(Math.random() * 1000000000)).padStart(9, '0');
                
                users.push({
                  userId: userId,
                  lrn: lrn,
                  email: email,
                  password: generatePassword(),
                  firstName: firstName,
                  middleName: middleName,
                  lastName: lastName,
                  contact: contact,
                  applicantLevel: 'Senior High School',
                  gradeLevel: grade,
                  strand: strand,
                  section: section,
                  gender: gender,
                  studentStatus: 'New Student',
                  lastSchool: 'Sample School',
                  sf1Submitted: Math.random() > 0.5, // 50% have submitted SF1
                  sf1Data: {
                    guardianFirstName: firstNames[Math.floor(Math.random() * firstNames.length)],
                    guardianLastName: lastNames[Math.floor(Math.random() * lastNames.length)],
                    guardianMiddleName: middleNames[Math.floor(Math.random() * middleNames.length)],
                    guardianExtension: '',
                    guardianRelationship: 'Parent',
                    motherFirstName: firstNames[Math.floor(Math.random() * firstNames.length)],
                    motherLastName: lastNames[Math.floor(Math.random() * lastNames.length)],
                    motherMiddleName: middleNames[Math.floor(Math.random() * middleNames.length)],
                    motherExtension: '',
                    fatherFirstName: firstNames[Math.floor(Math.random() * firstNames.length)],
                    fatherLastName: lastNames[Math.floor(Math.random() * lastNames.length)],
                    fatherMiddleName: middleNames[Math.floor(Math.random() * middleNames.length)],
                    fatherExtension: '',
                    gender: gender,
                    indigenous: 'No',
                    ethnicity: 'Filipino',
                    motherTongue: 'Tagalog',
                    religion: 'Catholic',
                    otherLanguages: 'English',
                    currentProvince: 'Metro Manila',
                    currentCity: 'Taguig City',
                    currentBarangay: 'Bagumbayan',
                    currentZip: '1630',
                    permanentProvince: 'Metro Manila',
                    permanentCity: 'Taguig City',
                    permanentBarangay: 'Bagumbayan',
                    permanentZip: '1630',
                    citizenship: 'Filipino',
                    isCCT: false,
                    specialNeeds: 'No',
                    lsenType: 'None',
                    vaccinated: 'Yes',
                    modality: 'Face-to-face'
                  }
                });
                
                studentCount++;
              }
            }
          }
        }
      }
      
      console.log(`Generated ${studentCount} sample students`);
      renderAdminTable();
    }

    
    function showPage(pageId) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById(pageId).classList.add('active');
      window.scrollTo(0, 0);
    }

    function generateCaptcha() {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      captchaText = '';
      for (let i = 0; i < 6; i++) {
        captchaText += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      document.getElementById('captchaDisplay').textContent = captchaText;
      document.getElementById('captchaInput').value = '';
    }

    function generatePassword() {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      let password = '';
      for (let i = 0; i < 8; i++) {
        password += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return password;
    }

    function toggleLevel() {
      const level = document.querySelector('input[name="applicantLevel"]:checked').value;
      if (level === 'Junior High School') {
        document.getElementById('jhsOptions').style.display = 'block';
        document.getElementById('shsOptions').style.display = 'none';
      } else {
        document.getElementById('jhsOptions').style.display = 'none';
        document.getElementById('shsOptions').style.display = 'block';
      }
    }

    function toggleLastSchool() {
      const status = document.querySelector('input[name="studentStatus"]:checked').value;
      document.getElementById('lastSchoolDiv').style.display = status === 'New Student' ? 'block' : 'none';
    }

    function toggleEthnicityDropdown() {
      const isIndigenous = document.querySelector('input[name="indigenous"]:checked').value === 'Yes';
      document.getElementById('ethnicityGroup').style.display = isIndigenous ? 'block' : 'none';
      document.getElementById('customEthnicityGroup').style.display = 'none';
      document.getElementById('ethnicitySelect').value = '';
      document.getElementById('customEthnicity').value = '';
    }

    function toggleLSENDropdown() {
      const hasSpecialNeeds = document.querySelector('input[name="specialNeeds"]:checked').value === 'Yes';
      document.getElementById('lsenClassificationGroup').style.display = hasSpecialNeeds ? 'block' : 'none';
      document.getElementById('lsenOtherGroup').style.display = 'none';
      document.querySelector('select[name="lsenType"]').value = '';
      document.querySelector('input[name="lsenTypeOther"]').value = '';
    }

    function handleLSENTypeChange() {
      const lsenType = document.querySelector('select[name="lsenType"]').value;
      const otherGroup = document.getElementById('lsenOtherGroup');
      
      if (lsenType === 'Other') {
        otherGroup.style.display = 'block';
      } else {
        otherGroup.style.display = 'none';
        document.querySelector('input[name="lsenTypeOther"]').value = '';
      }
    }

    // Validation and Preview Functions
    function handleSignupSubmit(event) {
      event.preventDefault();
      
      // Validate required fields
      const missingFields = validateSignupForm();
      
      if (missingFields.length > 0) {
        alert('âš ï¸ Please fill in all required fields:\n\n' + missingFields.join('\n'));
        return;
      }
      
      // Show preview modal
      showSignupPreview();
    }

    function validateSignupForm() {
      const missingFields = [];
      
      // Check Applicant Level
      const level = document.querySelector('input[name="applicantLevel"]:checked');
      if (!level) {
        missingFields.push('â€¢ Applicant Level');
      }
      
      // Check Grade Level
      if (level && level.value === 'Junior High School') {
        const grade = document.getElementById('jhsGrade').value;
        if (!grade) missingFields.push('â€¢ Grade Level (JHS)');
      } else if (level && level.value === 'Senior High School') {
        const grade = document.getElementById('shsGrade').value;
        if (!grade) missingFields.push('â€¢ Grade Level (SHS)');
        const strand = document.getElementById('strand').value;
        if (!strand) missingFields.push('â€¢ SHS Strand');
      }
      
      // Check Student Status
      const status = document.querySelector('input[name="studentStatus"]:checked');
      if (!status) {
        missingFields.push('â€¢ Student Status (Old/New)');
      }
      
      // Check Last School if New Student
      if (status && status.value === 'New Student') {
        const lastSchool = document.getElementById('lastSchool').value.trim();
        if (!lastSchool) missingFields.push('â€¢ Last School Attended');
      }
      
      // Check Personal Information
      const lrn = document.getElementById('lrn').value.trim();
      if (!lrn) missingFields.push('â€¢ LRN (Learner Reference Number)');
      
      const firstName = document.getElementById('firstName').value.trim();
      if (!firstName) missingFields.push('â€¢ Given Name');
      
      const lastName = document.getElementById('lastName').value.trim();
      if (!lastName) missingFields.push('â€¢ Last Name');
      
      const email = document.getElementById('email').value.trim();
      if (!email) missingFields.push('â€¢ Email Address');
      
      const email2 = document.getElementById('email2').value.trim();
      if (!email2) missingFields.push('â€¢ Re-enter Email Address');
      
      if (email && email2 && email !== email2) {
        missingFields.push('â€¢ Email addresses do not match');
      }
      
      const contact = document.getElementById('contact').value.trim();
      if (!contact) missingFields.push('â€¢ Contact Number');
      
      return missingFields;
    }

    function showSignupPreview() {
      const level = document.querySelector('input[name="applicantLevel"]:checked').value;
      const grade = level === 'Junior High School' ? 
        document.getElementById('jhsGrade').value : 
        document.getElementById('shsGrade').value;
      const strand = level === 'Senior High School' ? 
        document.getElementById('strand').value : 'N/A';
      const status = document.querySelector('input[name="studentStatus"]:checked').value;
      const lastSchool = status === 'New Student' ? 
        document.getElementById('lastSchool').value : 'N/A';
      
      const previewHTML = `
        <div style="background: white; padding: 40px; border-radius: 10px; max-width: 600px; margin: 0 auto;">
          <h2 style="color: #b30000; text-align: center; margin-bottom: 30px;">ðŸ“‹ Review Your Application</h2>
          
          <div style="background: #f9f9f9; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
            <h3 style="color: #b30000; margin-bottom: 15px;">Application Details</h3>
            <p><strong>Level:</strong> ${level}</p>
            <p><strong>Grade:</strong> Grade ${grade}</p>
            ${strand !== 'N/A' ? `<p><strong>Strand:</strong> ${strand}</p>` : ''}
            <p><strong>Student Status:</strong> ${status}</p>
            ${status === 'New Student' ? `<p><strong>Last School:</strong> ${lastSchool}</p>` : ''}
          </div>
          
          <div style="background: #f9f9f9; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
            <h3 style="color: #b30000; margin-bottom: 15px;">Personal Information</h3>
            <p><strong>LRN:</strong> ${document.getElementById('lrn').value}</p>
            <p><strong>Name:</strong> ${document.getElementById('firstName').value} ${document.getElementById('middleName').value} ${document.getElementById('lastName').value}</p>
            <p><strong>Email:</strong> ${document.getElementById('email').value}</p>
            <p><strong>Contact:</strong> ${document.getElementById('contact').value}</p>
          </div>
          
          <div style="display: flex; gap: 10px; justify-content: center;">
            <button onclick="closePreviewAndEdit()" style="padding: 12px 30px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 16px;">
              âœï¸ Edit
            </button>
            <button onclick="submitSignupForm()" style="padding: 12px 30px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 16px;">
              âœ… Apply Now
            </button>
          </div>
        </div>
      `;
      
      // Create modal
      const modal = document.createElement('div');
      modal.id = 'previewModal';
      modal.style.cssText = 'display: flex; position: fixed; z-index: 5000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; overflow-y: auto;';
      modal.innerHTML = previewHTML;
      document.body.appendChild(modal);
    }

    function closePreviewAndEdit() {
      const modal = document.getElementById('previewModal');
      if (modal) modal.remove();
    }

    function submitSignupForm() {
      const level = document.querySelector('input[name="applicantLevel"]:checked').value;
      const grade = level === 'Junior High School' ? 
        document.getElementById('jhsGrade').value : 
        document.getElementById('shsGrade').value;
      const strand = level === 'Senior High School' ? 
        document.getElementById('strand').value : 'N/A';
      const status = document.querySelector('input[name="studentStatus"]:checked').value;
      const lastSchool = status === 'New Student' ? 
        document.getElementById('lastSchool').value : 'N/A';
      
      const password = generatePassword();
      const userId = 'TNHS' + Date.now() + Math.random().toString(36).substr(2, 9);
      
      const user = {
        userId: userId,
        lrn: document.getElementById('lrn').value,
        email: document.getElementById('email').value,
        password: password,
        firstName: document.getElementById('firstName').value,
        middleName: document.getElementById('middleName').value,
        lastName: document.getElementById('lastName').value,
        contact: document.getElementById('contact').value,
        applicantLevel: level,
        gradeLevel: grade,
        strand: strand,
        section: assignSection(grade, strand),
        gender: 'Not Set',
        studentStatus: status,
        lastSchool: lastSchool,
        sf1Submitted: false,
        sf1Data: {}
      };
      
      users.push(user);
      
      // Close preview modal
      const modal = document.getElementById('previewModal');
      if (modal) modal.remove();
      
      // Show success modal
      document.getElementById('modalEmail').textContent = user.email;
      document.getElementById('modalPassword').textContent = user.password;
      document.getElementById('modalUserId').textContent = user.userId;
      document.getElementById('successModal').style.display = 'block';
      
      // Reset form
      document.getElementById('signupForm').reset();
      document.getElementById('jhsOptions').style.display = 'none';
      document.getElementById('shsOptions').style.display = 'none';
      document.getElementById('lastSchoolDiv').style.display = 'none';
    }

    function openAddCulturalModal() {
      const customValue = prompt('Please enter your cultural community name:');
      if (customValue && customValue.trim()) {
        const select = document.getElementById('ethnicitySelect');
        const option = document.createElement('option');
        option.value = customValue.trim();
        option.textContent = customValue.trim();
        select.appendChild(option);
        select.value = customValue.trim();
      }
    }

    // Barangay and Zip Code Database for Taguig City
    const barangayZipCodes = {
      'Bagumbayan': '1630',
      'Lower Bicutan': '1630',
      'Upper Bicutan': '1630',
      'Bonifacio': '1630',
      'Fort Bonifacio': '1630',
      'Pinagsama': '1630',
      'Taguig': '1630',
      'Pateros': '1630',
      'Maharlika': '1630',
      'Napindan': '1630',
      'Ususan': '1630',
      'Bambang': '1630',
      'Calero': '1630',
      'Hagonoy': '1630',
      'Ibayo': '1630',
      'Ligid-Tipas': '1630',
      'Palanggulo': '1630',
      'Rosario': '1630',
      'San Miguel': '1630',
      'Sta. Ana': '1630',
      'Wawa': '1630'
    };

    const cityBarangays = {
      'Metro Manila': {
        'Taguig City': Object.keys(barangayZipCodes)
      }
    };

    // Store custom locations added by users
    let customBarangays = {};
    let customCities = {};

    function updateCurrentCity() {
      const province = document.querySelector('select[name="currentProvince"]').value;
      const citySelect = document.querySelector('select[name="currentCity"]');
      const barangaySelect = document.querySelector('select[name="currentBarangay"]');
      
      citySelect.innerHTML = '<option value="">-- Select City/Municipality --</option>';
      barangaySelect.innerHTML = '<option value="">-- Select Barangay --</option>';
      document.querySelector('input[name="currentZip"]').value = '';
      
      if (province && cityBarangays[province]) {
        Object.keys(cityBarangays[province]).forEach(city => {
          const option = document.createElement('option');
          option.value = city;
          option.textContent = city;
          citySelect.appendChild(option);
        });
        
        // Add custom cities if any
        if (customCities[province]) {
          customCities[province].forEach(city => {
            const option = document.createElement('option');
            option.value = city;
            option.textContent = city + ' (Custom)';
            citySelect.appendChild(option);
          });
        }
      }
      
      // Add "Add Custom City" option
      const addCityOption = document.createElement('option');
      addCityOption.value = '__ADD_CUSTOM_CITY__';
      addCityOption.textContent = '+ Add Custom City';
      addCityOption.style.fontWeight = 'bold';
      addCityOption.style.color = '#28a745';
      citySelect.appendChild(addCityOption);
    }

    function updateCurrentBarangay() {
      const province = document.querySelector('select[name="currentProvince"]').value;
      const city = document.querySelector('select[name="currentCity"]').value;
      const citySelect = document.querySelector('select[name="currentCity"]');
      const barangaySelect = document.querySelector('select[name="currentBarangay"]');
      
      // Handle custom city addition
      if (city === '__ADD_CUSTOM_CITY__') {
        const customCity = prompt('Enter the name of the city/municipality:');
        if (customCity && customCity.trim()) {
          // Add to cityBarangays object so it works like predefined cities
          if (!cityBarangays[province]) {
            cityBarangays[province] = {};
          }
          cityBarangays[province][customCity.trim()] = [];
          
          // Re-populate cities and select the new one
          updateCurrentCity();
          citySelect.value = customCity.trim();
          updateCurrentBarangay();
        } else {
          citySelect.value = '';
        }
        return;
      }
      
      barangaySelect.innerHTML = '<option value="">-- Select Barangay --</option>';
      document.querySelector('input[name="currentZip"]').value = '';
      
      // Check if city exists in predefined cityBarangays
      if (province && city && cityBarangays[province] && cityBarangays[province][city]) {
        cityBarangays[province][city].forEach(barangay => {
          const option = document.createElement('option');
          option.value = barangay;
          option.textContent = barangay;
          barangaySelect.appendChild(option);
        });
      }
      
      // Add custom barangays if any
      const customKey = province + '|' + city;
      if (customBarangays[customKey]) {
        customBarangays[customKey].forEach(barangay => {
          const option = document.createElement('option');
          option.value = barangay;
          option.textContent = barangay + ' (Custom)';
          barangaySelect.appendChild(option);
        });
      }
      
      // Add "Add Custom Barangay" option
      const addBarangayOption = document.createElement('option');
      addBarangayOption.value = '__ADD_CUSTOM_BARANGAY__';
      addBarangayOption.textContent = '+ Add Custom Barangay';
      addBarangayOption.style.fontWeight = 'bold';
      addBarangayOption.style.color = '#28a745';
      barangaySelect.appendChild(addBarangayOption);
    }
    
    function handleCurrentBarangayChange() {
      const barangay = document.querySelector('select[name="currentBarangay"]').value;
      
      if (barangay === '__ADD_CUSTOM_BARANGAY__') {
        const province = document.querySelector('select[name="currentProvince"]').value;
        const city = document.querySelector('select[name="currentCity"]').value;
        handleAddCustomBarangay('current', province, city);
      } else {
        updateCurrentZip();
      }
    }

    function updateCurrentZip() {
      const barangay = document.querySelector('select[name="currentBarangay"]').value;
      const zipInput = document.querySelector('input[name="currentZip"]');
      
      if (barangay && barangayZipCodes[barangay]) {
        zipInput.value = barangayZipCodes[barangay];
      } else {
        zipInput.value = '';
      }
    }

    function updatePermanentCity() {
      const province = document.querySelector('select[name="permanentProvince"]').value;
      const citySelect = document.querySelector('select[name="permanentCity"]');
      const barangaySelect = document.querySelector('select[name="permanentBarangay"]');
      
      citySelect.innerHTML = '<option value="">-- Select City/Municipality --</option>';
      barangaySelect.innerHTML = '<option value="">-- Select Barangay --</option>';
      document.querySelector('input[name="permanentZip"]').value = '';
      
      if (province && cityBarangays[province]) {
        Object.keys(cityBarangays[province]).forEach(city => {
          const option = document.createElement('option');
          option.value = city;
          option.textContent = city;
          citySelect.appendChild(option);
        });
      }
    }

    function updatePermanentBarangay() {
      const province = document.querySelector('select[name="permanentProvince"]').value;
      const city = document.querySelector('select[name="permanentCity"]').value;
      const barangaySelect = document.querySelector('select[name="permanentBarangay"]');
      
      barangaySelect.innerHTML = '<option value="">-- Select Barangay --</option>';
      document.querySelector('input[name="permanentZip"]').value = '';
      
      // Check if city exists in predefined cityBarangays
      if (province && city && cityBarangays[province] && cityBarangays[province][city]) {
        cityBarangays[province][city].forEach(barangay => {
          const option = document.createElement('option');
          option.value = barangay;
          option.textContent = barangay;
          barangaySelect.appendChild(option);
        });
      }
      
      // Add custom barangays if any
      const customKey = province + '|' + city;
      if (customBarangays[customKey]) {
        customBarangays[customKey].forEach(barangay => {
          const option = document.createElement('option');
          option.value = barangay;
          option.textContent = barangay + ' (Custom)';
          barangaySelect.appendChild(option);
        });
      }
    }

    function updatePermanentZip() {
      const barangay = document.querySelector('select[name="permanentBarangay"]').value;
      const zipInput = document.querySelector('input[name="permanentZip"]');
      
      if (barangay && barangayZipCodes[barangay]) {
        zipInput.value = barangayZipCodes[barangay];
      } else {
        zipInput.value = '';
      }
    }

    function handleAddCustomBarangay(type, province, city) {
      const customBarangay = prompt('Enter the name of the barangay:');
      if (customBarangay && customBarangay.trim()) {
        const customKey = province + '|' + city;
        if (!customBarangays[customKey]) {
          customBarangays[customKey] = [];
        }
        customBarangays[customKey].push(customBarangay.trim());
        
        // Re-populate barangays and select the new one
        if (type === 'current') {
          updateCurrentBarangay();
          document.querySelector('select[name="currentBarangay"]').value = customBarangay.trim();
          updateCurrentZip();
        } else if (type === 'permanent') {
          updatePermanentBarangay();
          document.querySelector('select[name="permanentBarangay"]').value = customBarangay.trim();
          updatePermanentZip();
        }
      }
    }

    function copyCurrentToPermanent() {
      const checkbox = document.getElementById('sameAsCurrentAddress');
      if (checkbox.checked) {
        const currentProvince = document.querySelector('select[name="currentProvince"]').value;
        const currentCity = document.querySelector('select[name="currentCity"]').value;
        const currentBarangay = document.querySelector('select[name="currentBarangay"]').value;
        const currentZip = document.querySelector('input[name="currentZip"]').value;
        
        // Set province
        document.querySelector('select[name="permanentProvince"]').value = currentProvince;
        updatePermanentCity();
        
        // Wait for city dropdown to populate, then set city
        setTimeout(() => {
          document.querySelector('select[name="permanentCity"]').value = currentCity;
          updatePermanentBarangay();
          
          // Wait for barangay dropdown to populate, then set barangay
          setTimeout(() => {
            const permanentBarangaySelect = document.querySelector('select[name="permanentBarangay"]');
            permanentBarangaySelect.value = currentBarangay;
            
            // Trigger change event to update zip code
            const event = new Event('change', { bubbles: true });
            permanentBarangaySelect.dispatchEvent(event);
            
            // Also copy the zip code manually in case it was manually entered
            document.querySelector('input[name="permanentZip"]').value = currentZip;
          }, 100);
        }, 100);
      } else {
        // If unchecked, clear permanent address
        document.querySelector('select[name="permanentProvince"]').value = '';
        document.querySelector('select[name="permanentCity"]').value = '';
        document.querySelector('select[name="permanentBarangay"]').value = '';
        document.querySelector('input[name="permanentZip"]').value = '';
      }
    }

    function handleAddCustomBarangay(type, province, city) {
      const customBarangay = prompt('Enter the name of the barangay:');
      if (customBarangay && customBarangay.trim()) {
        const customKey = province + '|' + city;
        if (!customBarangays[customKey]) {
          customBarangays[customKey] = [];
        }
        customBarangays[customKey].push(customBarangay.trim());
        
        // Re-populate barangays and select the new one
        if (type === 'current') {
          updateCurrentBarangay();
          document.querySelector('select[name="currentBarangay"]').value = customBarangay.trim();
          updateCurrentZip();
        } else if (type === 'permanent') {
          updatePermanentBarangay();
          document.querySelector('select[name="permanentBarangay"]').value = customBarangay.trim();
          updatePermanentZip();
        }
      }
    }

    function validateCurrentZip() {
      // Allow manual entry - no validation needed, just accept whatever user enters
      // The zip code field is now editable
    }

    function validatePermanentZip() {
      // Allow manual entry - no validation needed, just accept whatever user enters
      // The zip code field is now editable
    }

    function goToLogin() {
      document.getElementById('successModal').style.display = 'none';
      showPage('loginPage');
    }

    function showSF1Preview() {
      // Collect all SF1 form data
      const formData = new FormData(document.getElementById('sf1Form'));
      const sf1Data = Object.fromEntries(formData);
      
      // Create preview modal content
      const previewHTML = `
        <div style="background: white; padding: 40px; border-radius: 10px; width: 100%; max-width: 900px;">
          <div style="text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 3px solid #b30000;">
            <h2 style="color: #b30000; margin: 0;">ðŸ“‹ Review Your SF1 Form</h2>
            <p style="color: #666; margin-top: 10px;">Please verify all information is correct before applying</p>
          </div>
          
          <div id="sf1PreviewContent" style="max-height: 60vh; overflow-y: auto; margin-bottom: 30px;">
            <!-- Guardian Information -->
            <div style="background: #f9f9f9; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
              <h3 style="color: #b30000; margin-bottom: 15px; border-bottom: 2px solid #ddd; padding-bottom: 10px;">ðŸ‘¨â€ðŸ‘©â€ðŸ‘§ Guardian Information</h3>
              <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                <div>
                  <p style="font-weight: bold; color: #555; font-size: 13px; margin-bottom: 5px;">Last Name</p>
                  <p style="color: #333; padding: 8px; background: white; border-radius: 4px; border: 1px solid #e0e0e0;">${sf1Data.guardianLastName || 'â€”'}</p>
                </div>
                <div>
                  <p style="font-weight: bold; color: #555; font-size: 13px; margin-bottom: 5px;">First Name</p>
                  <p style="color: #333; padding: 8px; background: white; border-radius: 4px; border: 1px solid #e0e0e0;">${sf1Data.guardianFirstName || 'â€”'}</p>
                </div>
                <div>
                  <p style="font-weight: bold; color: #555; font-size: 13px; margin-bottom: 5px;">Middle Name</p>
                  <p style="color: #333; padding: 8px; background: white; border-radius: 4px; border: 1px solid #e0e0e0;">${sf1Data.guardianMiddleName || 'â€”'}</p>
                </div>
                <div>
                  <p style="font-weight: bold; color: #555; font-size: 13px; margin-bottom: 5px;">Extension Name</p>
                  <p style="color: #333; padding: 8px; background: white; border-radius: 4px; border: 1px solid #e0e0e0;">${sf1Data.guardianExtension || 'â€”'}</p>
                </div>
                <div style="grid-column: 1 / -1;">
                  <p style="font-weight: bold; color: #555; font-size: 13px; margin-bottom: 5px;">Relationship</p>
                  <p style="color: #333; padding: 8px; background: white; border-radius: 4px; border: 1px solid #e0e0e0;">${sf1Data.guardianRelationship || 'â€”'}</p>
                </div>
              </div>
            </div>
            
            <!-- Mother's Information -->
            <div style="background: #f9f9f9; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
              <h3 style="color: #b30000; margin-bottom: 15px; border-bottom: 2px solid #ddd; padding-bottom: 10px;">ðŸ‘© Mother's Maiden Name</h3>
              <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                <div>
                  <p style="font-weight: bold; color: #555; font-size: 13px; margin-bottom: 5px;">Last Name</p>
                  <p style="color: #333; padding: 8px; background: white; border-radius: 4px; border: 1px solid #e0e0e0;">${sf1Data.motherLastName || 'â€”'}</p>
                </div>
                <div>
                  <p style="font-weight: bold; color: #555; font-size: 13px; margin-bottom: 5px;">First Name</p>
                  <p style="color: #333; padding: 8px; background: white; border-radius: 4px; border: 1px solid #e0e0e0;">${sf1Data.motherFirstName || 'â€”'}</p>
                </div>
                <div>
                  <p style="font-weight: bold; color: #555; font-size: 13px; margin-bottom: 5px;">Middle Name</p>
                  <p style="color: #333; padding: 8px; background: white; border-radius: 4px; border: 1px solid #e0e0e0;">${sf1Data.motherMiddleName || 'â€”'}</p>
                </div>
                <div>
                  <p style="font-weight: bold; color: #555; font-size: 13px; margin-bottom: 5px;">Extension Name</p>
                  <p style="color: #333; padding: 8px; background: white; border-radius: 4px; border: 1px solid #e0e0e0;">${sf1Data.motherExtension || 'â€”'}</p>
                </div>
              </div>
            </div>
            
            <!-- Father's Information -->
            <div style="background: #f9f9f9; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
              <h3 style="color: #b30000; margin-bottom: 15px; border-bottom: 2px solid #ddd; padding-bottom: 10px;">ðŸ‘¨ Father Information</h3>
              <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                <div>
                  <p style="font-weight: bold; color: #555; font-size: 13px; margin-bottom: 5px;">Last Name</p>
                  <p style="color: #333; padding: 8px; background: white; border-radius: 4px; border: 1px solid #e0e0e0;">${sf1Data.fatherLastName || 'â€”'}</p>
                </div>
                <div>
                  <p style="font-weight: bold; color: #555; font-size: 13px; margin-bottom: 5px;">First Name</p>
                  <p style="color: #333; padding: 8px; background: white; border-radius: 4px; border: 1px solid #e0e0e0;">${sf1Data.fatherFirstName || 'â€”'}</p>
                </div>
                <div>
                  <p style="font-weight: bold; color: #555; font-size: 13px; margin-bottom: 5px;">Middle Name</p>
                  <p style="color: #333; padding: 8px; background: white; border-radius: 4px; border: 1px solid #e0e0e0;">${sf1Data.fatherMiddleName || 'â€”'}</p>
                </div>
                <div>
                  <p style="font-weight: bold; color: #555; font-size: 13px; margin-bottom: 5px;">Extension Name</p>
                  <p style="color: #333; padding: 8px; background: white; border-radius: 4px; border: 1px solid #e0e0e0;">${sf1Data.fatherExtension || 'â€”'}</p>
                </div>
              </div>
            </div>
            
            <!-- Personal Information -->
            <div style="background: #f9f9f9; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
              <h3 style="color: #b30000; margin-bottom: 15px; border-bottom: 2px solid #ddd; padding-bottom: 10px;">ðŸ‘¤ Personal Information</h3>
              <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                <div>
                  <p style="font-weight: bold; color: #555; font-size: 13px; margin-bottom: 5px;">Gender</p>
                  <p style="color: #333; padding: 8px; background: white; border-radius: 4px; border: 1px solid #e0e0e0;">${sf1Data.gender || 'â€”'}</p>
                </div>
                <div>
                  <p style="font-weight: bold; color: #555; font-size: 13px; margin-bottom: 5px;">Indigenous Peoples</p>
                  <p style="color: #333; padding: 8px; background: white; border-radius: 4px; border: 1px solid #e0e0e0;">${sf1Data.indigenous || 'â€”'}</p>
                </div>
                ${sf1Data.ethnicity ? `
                <div>
                  <p style="font-weight: bold; color: #555; font-size: 13px; margin-bottom: 5px;">Cultural Community</p>
                  <p style="color: #333; padding: 8px; background: white; border-radius: 4px; border: 1px solid #e0e0e0;">${sf1Data.ethnicity}</p>
                </div>
                ` : ''}
              </div>
            </div>
            
            <!-- Mother Tongue & Religion -->
            <div style="background: #f9f9f9; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
              <h3 style="color: #b30000; margin-bottom: 15px; border-bottom: 2px solid #ddd; padding-bottom: 10px;">ðŸ—£ï¸ Mother Tongue & Religion</h3>
              <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                <div>
                  <p style="font-weight: bold; color: #555; font-size: 13px; margin-bottom: 5px;">Mother Tongue</p>
                  <p style="color: #333; padding: 8px; background: white; border-radius: 4px; border: 1px solid #e0e0e0;">${sf1Data.motherTongue || 'â€”'}</p>
                </div>
                <div>
                  <p style="font-weight: bold; color: #555; font-size: 13px; margin-bottom: 5px;">Religion</p>
                  <p style="color: #333; padding: 8px; background: white; border-radius: 4px; border: 1px solid #e0e0e0;">${sf1Data.religion || 'â€”'}</p>
                </div>
                <div style="grid-column: 1 / -1;">
                  <p style="font-weight: bold; color: #555; font-size: 13px; margin-bottom: 5px;">Other Spoken Languages</p>
                  <p style="color: #333; padding: 8px; background: white; border-radius: 4px; border: 1px solid #e0e0e0;">${sf1Data.otherLanguages || 'â€”'}</p>
                </div>
              </div>
            </div>
            
            <!-- Current Residence -->
            <div style="background: #f9f9f9; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
              <h3 style="color: #b30000; margin-bottom: 15px; border-bottom: 2px solid #ddd; padding-bottom: 10px;">ðŸ  Current Residence</h3>
              <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                <div>
                  <p style="font-weight: bold; color: #555; font-size: 13px; margin-bottom: 5px;">Province</p>
                  <p style="color: #333; padding: 8px; background: white; border-radius: 4px; border: 1px solid #e0e0e0;">${sf1Data.currentProvince || 'â€”'}</p>
                </div>
                <div>
                  <p style="font-weight: bold; color: #555; font-size: 13px; margin-bottom: 5px;">City/Municipality</p>
                  <p style="color: #333; padding: 8px; background: white; border-radius: 4px; border: 1px solid #e0e0e0;">${sf1Data.currentCity || 'â€”'}</p>
                </div>
                <div>
                  <p style="font-weight: bold; color: #555; font-size: 13px; margin-bottom: 5px;">Barangay</p>
                  <p style="color: #333; padding: 8px; background: white; border-radius: 4px; border: 1px solid #e0e0e0;">${sf1Data.currentBarangay || 'â€”'}</p>
                </div>
                <div>
                  <p style="font-weight: bold; color: #555; font-size: 13px; margin-bottom: 5px;">Zip Code</p>
                  <p style="color: #333; padding: 8px; background: white; border-radius: 4px; border: 1px solid #e0e0e0;">${sf1Data.currentZip || 'â€”'}</p>
                </div>
              </div>
            </div>
            
            <!-- Permanent Residence -->
            <div style="background: #f9f9f9; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
              <h3 style="color: #b30000; margin-bottom: 15px; border-bottom: 2px solid #ddd; padding-bottom: 10px;">ðŸ“ Permanent Residence</h3>
              <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                <div>
                  <p style="font-weight: bold; color: #555; font-size: 13px; margin-bottom: 5px;">Province</p>
                  <p style="color: #333; padding: 8px; background: white; border-radius: 4px; border: 1px solid #e0e0e0;">${sf1Data.permanentProvince || 'â€”'}</p>
                </div>
                <div>
                  <p style="font-weight: bold; color: #555; font-size: 13px; margin-bottom: 5px;">City/Municipality</p>
                  <p style="color: #333; padding: 8px; background: white; border-radius: 4px; border: 1px solid #e0e0e0;">${sf1Data.permanentCity || 'â€”'}</p>
                </div>
                <div>
                  <p style="font-weight: bold; color: #555; font-size: 13px; margin-bottom: 5px;">Barangay</p>
                  <p style="color: #333; padding: 8px; background: white; border-radius: 4px; border: 1px solid #e0e0e0;">${sf1Data.permanentBarangay || 'â€”'}</p>
                </div>
                <div>
                  <p style="font-weight: bold; color: #555; font-size: 13px; margin-bottom: 5px;">Zip Code</p>
                  <p style="color: #333; padding: 8px; background: white; border-radius: 4px; border: 1px solid #e0e0e0;">${sf1Data.permanentZip || 'â€”'}</p>
                </div>
              </div>
            </div>
            
            <!-- Additional Information -->
            <div style="background: #f9f9f9; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
              <h3 style="color: #b30000; margin-bottom: 15px; border-bottom: 2px solid #ddd; padding-bottom: 10px;">â„¹ï¸ Additional Information</h3>
              <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                <div>
                  <p style="font-weight: bold; color: #555; font-size: 13px; margin-bottom: 5px;">Citizenship</p>
                  <p style="color: #333; padding: 8px; background: white; border-radius: 4px; border: 1px solid #e0e0e0;">${sf1Data.citizenship || 'â€”'}</p>
                </div>
                <div>
                  <p style="font-weight: bold; color: #555; font-size: 13px; margin-bottom: 5px;">CCT Recipient</p>
                  <p style="color: #333; padding: 8px; background: white; border-radius: 4px; border: 1px solid #e0e0e0;">${sf1Data.isCCT ? 'Yes' : 'No'}</p>
                </div>
                <div>
                  <p style="font-weight: bold; color: #555; font-size: 13px; margin-bottom: 5px;">Special Educational Needs</p>
                  <p style="color: #333; padding: 8px; background: white; border-radius: 4px; border: 1px solid #e0e0e0;">${sf1Data.specialNeeds || 'â€”'}</p>
                </div>
                <div>
                  <p style="font-weight: bold; color: #555; font-size: 13px; margin-bottom: 5px;">COVID-19 Vaccinated</p>
                  <p style="color: #333; padding: 8px; background: white; border-radius: 4px; border: 1px solid #e0e0e0;">${sf1Data.vaccinated || 'â€”'}</p>
                </div>
                <div style="grid-column: 1 / -1;">
                  <p style="font-weight: bold; color: #555; font-size: 13px; margin-bottom: 5px;">Learning Modality</p>
                  <p style="color: #333; padding: 8px; background: white; border-radius: 4px; border: 1px solid #e0e0e0;">${sf1Data.modality || 'â€”'}</p>
                </div>
              </div>
            </div>
          </div>
          
          <div style="display: flex; gap: 15px; justify-content: center; padding-top: 20px; border-top: 2px solid #ddd;">
            <button onclick="closeSF1Preview()" style="padding: 12px 40px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 16px; transition: 0.3s;">
              âœï¸ Edit
            </button>
            <button onclick="submitSF1Form()" style="padding: 12px 40px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 16px; transition: 0.3s;">
              âœ… Apply
            </button>
          </div>
        </div>
      `;
      
      // Create and show modal
      const modal = document.createElement('div');
      modal.id = 'sf1PreviewModal';
      modal.style.cssText = 'display: flex; position: fixed; z-index: 5000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; overflow-y: auto; padding: 20px;';
      modal.innerHTML = previewHTML;
      document.body.appendChild(modal);
    }

    function closeSF1Preview() {
      const modal = document.getElementById('sf1PreviewModal');
      if (modal) modal.remove();
    }

    function submitSF1Form() {
      // Close preview modal
      closeSF1Preview();
      
      // Get current user
      if (!currentUser) {
        alert('Error: User not found');
        return;
      }
      
      // Collect form data
      const formData = new FormData(document.getElementById('sf1Form'));
      const sf1Data = Object.fromEntries(formData);
      
      // Update user's SF1 data
      currentUser.sf1Submitted = true;
      currentUser.sf1Data = sf1Data;
      
      // Update in users array
      const userIndex = users.findIndex(u => u.email === currentUser.email);
      if (userIndex !== -1) {
        users[userIndex] = currentUser;
      }
      
      // Show success message
      document.getElementById('successMessage').style.display = 'block';
      document.getElementById('sectionDisplay').textContent = `Your section has been assigned: ${currentUser.section}`;
      
      // Scroll to success message
      document.querySelector('.sf1-container').scrollIntoView({ behavior: 'smooth' });
      
      // Disable form after submission
      document.getElementById('sf1Form').style.opacity = '0.5';
      document.getElementById('sf1Form').style.pointerEvents = 'none';
      
      // Show logout button after 3 seconds
      setTimeout(() => {
        alert('âœ… Your SF1 form has been successfully submitted!\n\nYour section: ' + currentUser.section);
      }, 500);
    }

    function logout() {
      currentUser = null;
      showPage('homePage');
    }

    function logoutAdmin() {
      if (confirm('Logout?')) showPage('homePage');
    }

    function renderAdminTable() {
      const tbody = document.getElementById('adminTableBody');
      const filter = document.getElementById('strandFilter').value;
      const titleEl = document.getElementById('tableTitle');

      let filteredUsers = users;
      
      if (filter !== 'all') {
        if (filter === 'jhs') {
          filteredUsers = users.filter(u => u.applicantLevel === 'Junior High School');
          titleEl.textContent = 'All Junior High School Students';
        } else {
          // Check if filter includes a specific section (e.g., g11-STEM-A)
          const parts = filter.split('-');
          const gradeNum = parseInt(parts[0].substring(1));
          if (parts[1] === 'JUNIOR') {
            if (parts.length === 2) {
              // All Junior sections for a grade (e.g., g7-JUNIOR)
              filteredUsers = users.filter(u => u.applicantLevel === 'Junior High School' && u.gradeLevel === gradeNum);
              titleEl.textContent = `Grade ${gradeNum} - Junior High (All Sections)`;
            } else if (parts.length === 3) {
              // Specific Junior section (e.g., g7-JUNIOR-3)
              const secNum = parts[2];
              const section = `Section ${secNum}`;
              filteredUsers = users.filter(u => u.applicantLevel === 'Junior High School' && u.gradeLevel === gradeNum && u.section === section);
              titleEl.textContent = `Grade ${gradeNum} - Junior: ${section}`;
            }
          } else if (parts.length === 3) {
            // Specific section filter (e.g., g11-STEM-A)
            const strand = parts[1];
            const section = `${strand}-${parts[2]}`;
            filteredUsers = users.filter(u => u.gradeLevel === gradeNum && u.strand === strand && u.section === section);
            titleEl.textContent = `Grade ${gradeNum} - ${section}`;
          } else if (parts.length === 4) {
            // TVL specific section filter (e.g., g11-TVL-ICT-A)
            const strand = `${parts[1]}-${parts[2]}`;
            const section = `${strand}-${parts[3]}`;
            filteredUsers = users.filter(u => u.gradeLevel === gradeNum && u.strand === strand && u.section === section);
            titleEl.textContent = `Grade ${gradeNum} - ${section}`;
          } else {
            // All sections of a strand (e.g., g11-STEM or g11-TVL-ICT)
            const strand = parts.slice(1).join('-');
            filteredUsers = users.filter(u => u.gradeLevel === gradeNum && u.strand === strand);
            titleEl.textContent = `Grade ${gradeNum} - ${strand} (All Sections)`;
          }
        }
      } else {
        titleEl.textContent = 'All Students';
      }

      if (filteredUsers.length === 0) {
        tbody.innerHTML = '<tr><td colspan="13" style="text-align:center; padding:40px;">No students found</td></tr>';
      } else {
        const sortedUsers = [...filteredUsers].sort((a, b) => {
          // First sort by grade level
          if (a.gradeLevel !== b.gradeLevel) {
            return a.gradeLevel - b.gradeLevel;
          }
          // Then by strand
          if (a.strand !== b.strand) {
            return a.strand.localeCompare(b.strand);
          }
          // Then by section
          if ((a.section || '') !== (b.section || '')) {
            return (a.section || '').localeCompare(b.section || '');
          }
          // Then by gender (Female first, then Male, then N/A)
          const genderA = a.gender || 'N/A';
          const genderB = b.gender || 'N/A';
          if (genderA !== genderB) {
            if (genderA === 'Female') return -1;
            if (genderB === 'Female') return 1;
            if (genderA === 'Male') return -1;
            if (genderB === 'Male') return 1;
          }
          // Finally by last name alphabetically
          return (a.lastName || '').localeCompare(b.lastName || '');
        });

        tbody.innerHTML = sortedUsers.map((user, i) => {
          const sectionDisplay = user.section === 'Pending Assignment' 
            ? '<span style="color: orange; font-weight: bold;">â³ Pending</span>' 
            : user.section 
              ? `<strong style="color: green;">${user.section}</strong>` 
              : '<span style="color: #999;">Not Assigned</span>';
          
          const showAssignButton = !user.section || user.section === 'Pending Assignment' || user.section === 'Not Assigned';
          const showEditButton = user.section && user.section !== 'Pending Assignment' && user.section !== 'Not Assigned';
          
          return `
            <tr>
              <td class="row-number">${i + 1}</td>
              <td>${user.userId}</td>
              <td>${user.lrn || 'N/A'}</td>
              <td>${user.firstName} ${user.middleName || ''} ${user.lastName}</td>
              <td>${user.gender || 'N/A'}</td>
              <td>Grade ${user.gradeLevel}</td>
              <td>${user.strand}</td>
              <td>${sectionDisplay}</td>
              <td>${user.applicantLevel}</td>
              <td>${user.studentStatus}</td>
              <td>${user.email}</td>
              <td><code style="background: #f0f0f0; padding: 4px 8px; border-radius: 3px; font-weight: bold;">${user.password}</code></td>
              <td>${user.contact}</td>
              <td>${user.sf1Submitted ? '<span style="color: green;">âœ“ Done</span>' : '<span style="color: orange;">Pending</span>'}</td>
              <td>
                ${showAssignButton ? `<button class="btn-edit" onclick="openSectionModal('${user.userId}')">Assign Section</button><br>` : ''}
                ${showEditButton ? `<button class="btn-edit" onclick="openSectionModal('${user.userId}')">Edit Section</button><br>` : ''}
                ${user.sf1Submitted ? `<button class="btn-delete" style="background: #007bff; margin-bottom: 5px;" onclick="viewSF1('${user.userId}')">View SF1</button><br>` : ''}
                <button class="btn-delete" onclick="deleteStudent('${user.userId}')">Delete</button>
              </td>
            </tr>
          `;
        }).join('');
      }

      // Update statistics based on FILTERED users (not all users)
      document.getElementById('totalStudents').textContent = filteredUsers.length;
      document.getElementById('jhsCount').textContent = filteredUsers.filter(u => u.applicantLevel === 'Junior High School').length;
      document.getElementById('shsCount').textContent = filteredUsers.filter(u => u.applicantLevel === 'Senior High School').length;
      document.getElementById('sf1CompletedCount').textContent = filteredUsers.filter(u => u.sf1Submitted).length;
      document.getElementById('femaleCount').textContent = filteredUsers.filter(u => u.gender === 'Female').length;
      document.getElementById('maleCount').textContent = filteredUsers.filter(u => u.gender === 'Male').length;
    }

    function filterTable() {
      const searchInput = document.getElementById('searchInput').value.toLowerCase();
      const tbody = document.getElementById('adminTableBody');
      const rows = tbody.querySelectorAll('tr');
      
      rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        let found = false;
        
        // Search in Student ID, LRN, Name, and Email columns
        if (cells.length > 0) {
          const studentId = cells[1]?.textContent.toLowerCase() || '';
          const lrn = cells[2]?.textContent.toLowerCase() || '';
          const name = cells[3]?.textContent.toLowerCase() || '';
          const email = cells[10]?.textContent.toLowerCase() || '';
          
          if (studentId.includes(searchInput) || 
              lrn.includes(searchInput) || 
              name.includes(searchInput) || 
              email.includes(searchInput)) {
            found = true;
          }
        }
        
        row.style.display = found ? '' : 'none';
      });
    }

    function deleteStudent(userId) {
      const index = users.findIndex(u => u.userId === userId);
      if (index !== -1 && confirm('Delete this student?')) {
        users.splice(index, 1);
        renderAdminTable();
      }
    }

    function viewSF1(userId) {
      const user = users.find(u => u.userId === userId);
      if (!user || !user.sf1Data) return;
      
      const sf1 = user.sf1Data;
      const modal = document.getElementById('sf1ViewModal');
      
      // Build editable SF1 form
      let html = `
        <form id="sf1EditForm" onsubmit="saveSF1Edits(event, '${userId}')">
          <div class="sf1-modal-header">
            <h2>Student Enrollment Form (SF1) - Edit</h2>
            <p style="color: #666; margin-top: 10px;">
              <strong>Student:</strong> ${user.firstName} ${user.middleName || ''} ${user.lastName}<br>
              <strong>Student ID:</strong> ${user.userId} | <strong>LRN:</strong> ${user.lrn}<br>
              <strong>Grade ${user.gradeLevel}</strong> - ${user.strand} - <strong>Section: ${user.section}</strong>
            </p>
          </div>
          
          <div class="sf1-data-section">
            <h4>Guardian Information</h4>
            <div class="sf1-data-grid">
              <div class="form-group">
                <label>Guardian First Name</label>
                <input type="text" name="guardianFirstName" value="${sf1.guardianFirstName || ''}">
              </div>
              <div class="form-group">
                <label>Guardian Middle Name</label>
                <input type="text" name="guardianMiddleName" value="${sf1.guardianMiddleName || ''}">
              </div>
              <div class="form-group">
                <label>Guardian Last Name</label>
                <input type="text" name="guardianLastName" value="${sf1.guardianLastName || ''}">
              </div>
              <div class="form-group">
                <label>Guardian Extension</label>
                <input type="text" name="guardianExtension" value="${sf1.guardianExtension || ''}">
              </div>
              <div class="form-group">
                <label>Guardian Relationship</label>
                <input type="text" name="guardianRelationship" value="${sf1.guardianRelationship || ''}">
              </div>
            </div>
          </div>
          
          <div class="sf1-data-section">
            <h4>Mother's Information</h4>
            <div class="sf1-data-grid">
              <div class="form-group">
                <label>Mother First Name</label>
                <input type="text" name="motherFirstName" value="${sf1.motherFirstName || ''}">
              </div>
              <div class="form-group">
                <label>Mother Middle Name</label>
                <input type="text" name="motherMiddleName" value="${sf1.motherMiddleName || ''}">
              </div>
              <div class="form-group">
                <label>Mother Last Name</label>
                <input type="text" name="motherLastName" value="${sf1.motherLastName || ''}">
              </div>
              <div class="form-group">
                <label>Mother Extension</label>
                <input type="text" name="motherExtension" value="${sf1.motherExtension || ''}">
              </div>
            </div>
          </div>
          
          <div class="sf1-data-section">
            <h4>Father's Information</h4>
            <div class="sf1-data-grid">
              <div class="form-group">
                <label>Father First Name</label>
                <input type="text" name="fatherFirstName" value="${sf1.fatherFirstName || ''}">
              </div>
              <div class="form-group">
                <label>Father Middle Name</label>
                <input type="text" name="fatherMiddleName" value="${sf1.fatherMiddleName || ''}">
              </div>
              <div class="form-group">
                <label>Father Last Name</label>
                <input type="text" name="fatherLastName" value="${sf1.fatherLastName || ''}">
              </div>
              <div class="form-group">
                <label>Father Extension</label>
                <input type="text" name="fatherExtension" value="${sf1.fatherExtension || ''}">
              </div>
            </div>
          </div>
          
          <div class="sf1-data-section">
            <h4>Personal Information</h4>
            <div class="form-group">
              <label>Gender</label>
              <div class="radio-group">
                <label><input type="radio" name="gender" value="Male" ${sf1.gender === 'Male' ? 'checked' : ''}> Male</label>
                <label><input type="radio" name="gender" value="Female" ${sf1.gender === 'Female' ? 'checked' : ''}> Female</label>
              </div>
            </div>
          </div>
          
          <div class="sf1-data-section">
            <h4>Cultural & Language Information</h4>
            <div class="sf1-data-grid">
              <div class="form-group">
                <label>Indigenous Peoples Member</label>
                <div class="radio-group">
                  <label><input type="radio" name="indigenous" value="Yes" ${sf1.indigenous === 'Yes' ? 'checked' : ''}> Yes</label>
                  <label><input type="radio" name="indigenous" value="No" ${sf1.indigenous === 'No' || !sf1.indigenous ? 'checked' : ''}> No</label>
                </div>
              </div>
              <div class="form-group">
                <label>Ethnicity</label>
                <input type="text" name="ethnicity" value="${sf1.ethnicity || ''}">
              </div>
              <div class="form-group">
                <label>Mother Tongue</label>
                <input type="text" name="motherTongue" value="${sf1.motherTongue || ''}">
              </div>
              <div class="form-group">
                <label>Religion</label>
                <input type="text" name="religion" value="${sf1.religion || ''}">
              </div>
              <div class="form-group">
                <label>Other Languages</label>
                <input type="text" name="otherLanguages" value="${sf1.otherLanguages || ''}">
              </div>
            </div>
          </div>
          
          <div class="sf1-data-section">
            <h4>Current Residence</h4>
            <div class="sf1-data-grid">
              <div class="form-group">
                <label>Province</label>
                <input type="text" name="currentProvince" value="${sf1.currentProvince || ''}">
              </div>
              <div class="form-group">
                <label>City/Municipality</label>
                <input type="text" name="currentCity" value="${sf1.currentCity || ''}">
              </div>
              <div class="form-group">
                <label>Barangay</label>
                <input type="text" name="currentBarangay" value="${sf1.currentBarangay || ''}">
              </div>
              <div class="form-group">
                <label>Zip Code</label>
                <input type="text" name="currentZip" value="${sf1.currentZip || ''}">
              </div>
            </div>
          </div>
          
          <div class="sf1-data-section">
            <h4>Permanent Residence</h4>
            <div class="sf1-data-grid">
              <div class="form-group">
                <label>Province</label>
                <input type="text" name="permanentProvince" value="${sf1.permanentProvince || ''}">
              </div>
              <div class="form-group">
                <label>City/Municipality</label>
                <input type="text" name="permanentCity" value="${sf1.permanentCity || ''}">
              </div>
              <div class="form-group">
                <label>Barangay</label>
                <input type="text" name="permanentBarangay" value="${sf1.permanentBarangay || ''}">
              </div>
              <div class="form-group">
                <label>Zip Code</label>
                <input type="text" name="permanentZip" value="${sf1.permanentZip || ''}">
              </div>
            </div>
          </div>
          
          <div class="sf1-data-section">
            <h4>Additional Information</h4>
            <div class="sf1-data-grid">
              <div class="form-group">
                <label>Citizenship</label>
                <input type="text" name="citizenship" value="${sf1.citizenship || ''}">
              </div>
              <div class="form-group">
                <label>CCT Recipient</label>
                <div class="radio-group">
                  <label><input type="checkbox" name="isCCT" ${sf1.isCCT ? 'checked' : ''}> Yes</label>
                </div>
              </div>
              <div class="form-group">
                <label>Special Educational Needs</label>
                <div class="radio-group">
                  <label><input type="radio" name="specialNeeds" value="Yes" ${sf1.specialNeeds === 'Yes' ? 'checked' : ''}> Yes</label>
                  <label><input type="radio" name="specialNeeds" value="No" ${sf1.specialNeeds === 'No' || !sf1.specialNeeds ? 'checked' : ''}> No</label>
                </div>
              </div>
              <div class="form-group">
                <label>LSEN Type</label>
                <input type="text" name="lsenType" value="${sf1.lsenType || ''}">
              </div>
              <div class="form-group">
                <label>COVID-19 Vaccinated</label>
                <div class="radio-group">
                  <label><input type="radio" name="vaccinated" value="Yes" ${sf1.vaccinated === 'Yes' ? 'checked' : ''}> Yes</label>
                  <label><input type="radio" name="vaccinated" value="No" ${sf1.vaccinated === 'No' || !sf1.vaccinated ? 'checked' : ''}> No</label>
                </div>
              </div>
              <div class="form-group">
                <label>Learning Modality</label>
                <input type="text" name="modality" value="${sf1.modality || ''}">
              </div>
            </div>
          </div>
          
          <div style="display: flex; gap: 10px; justify-content: center; margin-top: 30px;">
            <button type="submit" class="btn-save">Save Changes</button>
            <button type="button" class="btn-cancel" onclick="closeSF1Modal()">Cancel</button>
          </div>
        </form>
      `;
      
      document.getElementById('sf1ModalContent').innerHTML = html;
      modal.style.display = 'block';
    }
    
    function saveSF1Edits(event, userId) {
      event.preventDefault();
      const user = users.find(u => u.userId === userId);
      if (!user) return;
      
      const form = document.getElementById('sf1EditForm');
      const formData = new FormData(form);
      
      // Update SF1 data
      user.sf1Data = {
        guardianFirstName: formData.get('guardianFirstName'),
        guardianMiddleName: formData.get('guardianMiddleName'),
        guardianLastName: formData.get('guardianLastName'),
        guardianExtension: formData.get('guardianExtension'),
        guardianRelationship: formData.get('guardianRelationship'),
        motherFirstName: formData.get('motherFirstName'),
        motherMiddleName: formData.get('motherMiddleName'),
        motherLastName: formData.get('motherLastName'),
        motherExtension: formData.get('motherExtension'),
        fatherFirstName: formData.get('fatherFirstName'),
        fatherMiddleName: formData.get('fatherMiddleName'),
        fatherLastName: formData.get('fatherLastName'),
        fatherExtension: formData.get('fatherExtension'),
        gender: formData.get('gender'),
        indigenous: formData.get('indigenous'),
        ethnicity: formData.get('ethnicity'),
        motherTongue: formData.get('motherTongue'),
        religion: formData.get('religion'),
        otherLanguages: formData.get('otherLanguages'),
        currentProvince: formData.get('currentProvince'),
        currentCity: formData.get('currentCity'),
        currentBarangay: formData.get('currentBarangay'),
        currentZip: formData.get('currentZip'),
        permanentProvince: formData.get('permanentProvince'),
        permanentCity: formData.get('permanentCity'),
        permanentBarangay: formData.get('permanentBarangay'),
        permanentZip: formData.get('permanentZip'),
        citizenship: formData.get('citizenship'),
        isCCT: formData.get('isCCT') ? 'Yes' : '',
        specialNeeds: formData.get('specialNeeds'),
        lsenType: formData.get('lsenType'),
        vaccinated: formData.get('vaccinated'),
        modality: formData.get('modality')
      };
      
      // Mark SF1 as submitted
      user.sf1Submitted = true;
      
      // Close modal and refresh table
      closeSF1Modal();
      renderAdminTable();
      alert('SF1 data updated successfully!');
    }
    
    function closeSF1Modal() {
      document.getElementById('sf1ViewModal').style.display = 'none';
    }

    function exportToExcel(data, fileName) {
      // Create workbook and worksheet
      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Students');
      
      // Auto-fit columns
      const colWidths = [];
      const headers = Object.keys(data[0] || {});
      
      headers.forEach((header, idx) => {
        let maxLength = header.length;
        data.forEach(row => {
          const cellValue = String(row[header] || '');
          maxLength = Math.max(maxLength, cellValue.length);
        });
        colWidths[idx] = { wch: Math.min(maxLength + 2, 50) };
      });
      
      ws['!cols'] = colWidths;
      
      // Add header styling
      const headerStyle = {
        fill: { fgColor: { rgb: 'FF2d8b2d' } },
        font: { bold: true, color: { rgb: 'FFFFFFFF' } },
        alignment: { horizontal: 'center', vertical: 'center', wrapText: true }
      };
      
      headers.forEach((header, idx) => {
        const cellRef = XLSX.utils.encode_col(idx) + '1';
        if (!ws[cellRef]) ws[cellRef] = {};
        ws[cellRef].s = headerStyle;
      });
      
      // Add row height for header
      ws['!rows'] = [{ hpx: 25 }];
      
      // Download file
      XLSX.writeFile(wb, `${fileName}_${new Date().toISOString().split('T')[0]}.xlsx`);
    }

    function downloadBySection() {
      if (users.length === 0) {
        alert('No student data to download!');
        return;
      }

      // Group students by section
      const sectionGroups = {};
      
      users.forEach(user => {
        const sectionKey = user.section || 'Unassigned';
        const gradeStrand = user.strand === 'N/A' 
          ? `Grade_${user.gradeLevel}` 
          : `Grade_${user.gradeLevel}_${user.strand}`;
        const fullKey = `${gradeStrand}_${sectionKey}`;
        
        if (!sectionGroups[fullKey]) {
          sectionGroups[fullKey] = [];
        }
        sectionGroups[fullKey].push(user);
      });

      // Define CSV headers
      const headers = [
        'Student ID',
        'LRN',
        'First Name',
        'Middle Name',
        'Last Name',
        'Gender',
        'Email',
        'Contact Number',
        'Applicant Level',
        'Grade Level',
        'Strand',
        'Section',
        'Student Status',
        'Last School Attended',
        'SF1 Status',
        'Guardian First Name',
        'Guardian Middle Name',
        'Guardian Last Name',
        'Guardian Extension',
        'Guardian Relationship',
        'Mother First Name',
        'Mother Middle Name',
        'Mother Last Name',
        'Mother Extension',
        'Father First Name',
        'Father Middle Name',
        'Father Last Name',
        'Father Extension',
        'Indigenous Peoples  Member',
        'Ethnicity',
        'Mother Tongue',
        'Religion',
        'Other Languages',
        'Current Province',
        'Current City',
        'Current Barangay',
        'Current Zip Code',
        'Permanent Province',
        'Permanent City',
        'Permanent Barangay',
        'Permanent Zip Code',
        'Citizenship',
        'CCT Recipient',
        'Special Educational Needs',
        'LSEN Type',
        'COVID-19 Vaccinated',
        'Learning Modality'
      ];

      let totalDownloaded = 0;
      const dateStamp = new Date().toISOString().split('T')[0];

      // Create a CSV file for each section
      Object.keys(sectionGroups).sort().forEach(sectionKey => {
        const students = sectionGroups[sectionKey];
        
        // Sort students within section: Female first, then Male, then N/A
        const sortedStudents = [...students].sort((a, b) => {
          const genderA = a.gender || 'N/A';
          const genderB = b.gender || 'N/A';
          if (genderA !== genderB) {
            if (genderA === 'Female') return -1;
            if (genderB === 'Female') return 1;
            if (genderA === 'Male') return -1;
            if (genderB === 'Male') return 1;
          }
          // Finally by last name alphabetically
          return (a.lastName || '').localeCompare(b.lastName || '');
        });

        // Build CSV content
        let csvContent = headers.join(',') + '\n';

        sortedStudents.forEach(user => {
          const sf1 = user.sf1Data || {};
          
          const row = [
            user.userId || '',
            user.lrn || '',
            user.firstName || '',
            user.middleName || '',
            user.lastName || '',
            user.gender || '',
            user.email || '',
            user.contact || '',
            user.applicantLevel || '',
            user.gradeLevel || '',
            user.strand || '',
            user.section || 'Not Assigned',
            user.studentStatus || '',
            user.lastSchool || '',
            user.sf1Submitted ? 'Completed' : 'Pending',
            sf1.guardianFirstName || '',
            sf1.guardianMiddleName || '',
            sf1.guardianLastName || '',
            sf1.guardianExtension || '',
            sf1.guardianRelationship || '',
            sf1.motherFirstName || '',
            sf1.motherMiddleName || '',
            sf1.motherLastName || '',
            sf1.motherExtension || '',
            sf1.fatherFirstName || '',
            sf1.fatherMiddleName || '',
            sf1.fatherLastName || '',
            sf1.fatherExtension || '',
            sf1.indigenous || '',
            sf1.ethnicity || '',
            sf1.motherTongue || '',
            sf1.religion || '',
            sf1.otherLanguages || '',
            sf1.currentProvince || '',
            sf1.currentCity || '',
            sf1.currentBarangay || '',
            sf1.currentZip || '',
            sf1.permanentProvince || '',
            sf1.permanentCity || '',
            sf1.permanentBarangay || '',
            sf1.permanentZip || '',
            sf1.citizenship || '',
            sf1.isCCT || '',
            sf1.specialNeeds || '',
            sf1.lsenType || '',
            sf1.vaccinated || '',
            sf1.modality || ''
          ];

          // Escape commas and quotes in data
          const escapedRow = row.map(field => {
            const stringField = String(field);
            if (stringField.includes(',') || stringField.includes('"') || stringField.includes('\n')) {
              return '"' + stringField.replace(/"/g, '""') + '"';
            }
            return stringField;
          });

          csvContent += escapedRow.join(',') + '\n';
        });

        // Create download link for this section
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        
        const fileName = `TNHS_${sectionKey}_${dateStamp}.csv`;
        link.setAttribute('href', url);
        link.setAttribute('download', fileName);
        link.style.visibility = 'hidden';
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        totalDownloaded += students.length;
        
        // Small delay between downloads to prevent browser blocking
        setTimeout(() => {}, 100);
      });

      alert(`Successfully downloaded ${Object.keys(sectionGroups).length} section file(s) with ${totalDownloaded} total student(s)!\n\nEach file is organized by:\n- Section\n- Gender (Female â†’ Male)\n- Last Name (A-Z)`);
    }

    function downloadStudentData() {
      const filter = document.getElementById('strandFilter').value;

      if (users.length === 0) {
        alert('No student data to download!');
        return;
      }

      // Get filtered users based on current view
      let filteredUsers = users;
      let fileName = 'TNHS_All_Students';

      if (filter !== 'all') {
        if (filter === 'jhs') {
          filteredUsers = users.filter(u => u.applicantLevel === 'Junior High School');
          fileName = 'TNHS_JHS_Students';
        } else {
          const parts = filter.split('-');
          if (parts.length === 3) {
            const gradeNum = parseInt(parts[0].substring(1));
            const strand = parts[1];
            const section = `${strand}-${parts[2]}`;
            filteredUsers = users.filter(u => u.gradeLevel === gradeNum && u.strand === strand && u.section === section);
            fileName = `TNHS_Grade${gradeNum}_${section}`;
          } else if (parts.length === 4) {
            const gradeNum = parseInt(parts[0].substring(1));
            const strand = `${parts[1]}-${parts[2]}`;
            const section = `${strand}-${parts[3]}`;
            filteredUsers = users.filter(u => u.gradeLevel === gradeNum && u.strand === strand && u.section === section);
            fileName = `TNHS_Grade${gradeNum}_${section}`;
          } else {
            const gradeNum = parseInt(parts[0].substring(1));
            const strand = parts.slice(1).join('-');
            filteredUsers = users.filter(u => u.gradeLevel === gradeNum && u.strand === strand);
            fileName = `TNHS_Grade${gradeNum}_${strand}`;
          }
        }
      }

      if (filteredUsers.length === 0) {
        alert('No students in current view to download!');
        return;
      }

      // Define CSV headers
      const headers = [
        'Student ID',
        'LRN',
        'First Name',
        'Middle Name',
        'Last Name',
        'Gender',
        'Email',
        'Contact Number',
        'Applicant Level',
        'Grade Level',
        'Strand',
        'Section',
        'Student Status',
        'Last School Attended',
        'SF1 Status',
        'Guardian First Name',
        'Guardian Middle Name',
        'Guardian Last Name',
        'Guardian Extension',
        'Guardian Relationship',
        'Mother First Name',
        'Mother Middle Name',
        'Mother Last Name',
        'Mother Extension',
        'Father First Name',
        'Father Middle Name',
        'Father Last Name',
        'Father Extension',
        'Indigenous Peoples Member',
        'Ethnicity',
        'Mother Tongue',
        'Religion',
        'Other Languages',
        'Current Province',
        'Current City',
        'Current Barangay',
        'Current Zip Code',
        'Permanent Province',
        'Permanent City',
        'Permanent Barangay',
        'Permanent Zip Code',
        'Citizenship',
        'CCT Recipient',
        'Special Educational Needs',
        'LSEN Type',
        'COVID-19 Vaccinated',
        'Learning Modality'
      ];

      // Build CSV content
      let csvContent = headers.join(',') + '\n';

      // Sort users by gender (Female first, then Male, then N/A), then by last name alphabetically
      const sortedUsers = [...filteredUsers].sort((a, b) => {
        const genderA = a.gender || 'N/A';
        const genderB = b.gender || 'N/A';
        if (genderA !== genderB) {
          if (genderA === 'Female') return -1;
          if (genderB === 'Female') return 1;
          if (genderA === 'Male') return -1;
          if (genderB === 'Male') return 1;
        }
        // Then by last name alphabetically
        return (a.lastName || '').localeCompare(b.lastName || '');
      });

      sortedUsers.forEach(user => {
        const sf1 = user.sf1Data || {};
        const row = [
          user.userId || '',
          user.lrn || '',
          user.firstName || '',
          user.middleName || '',
          user.lastName || '',
          user.gender || '',
          user.email || '',
          user.contact || '',
          user.applicantLevel || '',
          user.gradeLevel || '',
          user.strand || '',
          user.section || 'Not Assigned',
          user.studentStatus || '',
          user.lastSchool || '',
          user.sf1Submitted ? 'Completed' : 'Pending',
          sf1.guardianFirstName || '',
          sf1.guardianMiddleName || '',
          sf1.guardianLastName || '',
          sf1.guardianExtension || '',
          sf1.guardianRelationship || '',
          sf1.motherFirstName || '',
          sf1.motherMiddleName || '',
          sf1.motherLastName || '',
          sf1.motherExtension || '',
          sf1.fatherFirstName || '',
          sf1.fatherMiddleName || '',
          sf1.fatherLastName || '',
          sf1.fatherExtension || '',
          sf1.indigenous || '',
          sf1.ethnicity || '',
          sf1.motherTongue || '',
          sf1.religion || '',
          sf1.otherLanguages || '',
          sf1.currentProvince || '',
          sf1.currentCity || '',
          sf1.currentBarangay || '',
          sf1.currentZip || '',
          sf1.permanentProvince || '',
          sf1.permanentCity || '',
          sf1.permanentBarangay || '',
          sf1.permanentZip || '',
          sf1.citizenship || '',
          sf1.isCCT || '',
          sf1.specialNeeds || '',
          sf1.lsenType || '',
          sf1.vaccinated || '',
          sf1.modality || ''
        ];

        // Escape commas and quotes in data
        const escapedRow = row.map(field => {
          const stringField = String(field);
          if (stringField.includes(',') || stringField.includes('"') || stringField.includes('\n')) {
            return '"' + stringField.replace(/"/g, '""') + '"';
          }
          return stringField;
        });

        csvContent += escapedRow.join(',') + '\n';
      });

      // Create download link
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      const dateStamp = new Date().toISOString().split('T')[0];
      
      link.setAttribute('href', url);
      link.setAttribute('download', `TNHS_Student_Data_${new Date().toISOString().split('T')[0]}.csv`);
      link.style.visibility = 'hidden';
      
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      closeDownloadModal();
      alert(`Successfully downloaded all student data!\n\nTotal: ${users.length} student(s)\n\nFile is organized by:\n- Grade Level\n- Strand\n- Section\n- Gender (Female â†’ Male)\n- Last Name (A-Z)`);
    }

    document.getElementById('adminLoginForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const username = document.getElementById('adminUsername').value;
      const password = document.getElementById('adminPassword').value;
      
      if (username === 'admin' && password === 'admin123') {
        document.getElementById('adminNameDisplay').textContent = username;
        document.getElementById('adminErrorMessage').style.display = 'none';
        renderAdminTable();
        showPage('adminDashboard');
        this.reset();
      } else {
        document.getElementById('adminErrorMessage').style.display = 'block';
      }
    });

    document.getElementById('signupForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const email = document.getElementById('email').value;
      const email2 = document.getElementById('email2').value;
      
      if (email !== email2) {
        alert('Emails do not match!');
        return;
      }

      const userCaptcha = document.getElementById('captchaInput').value;
      if (userCaptcha !== captchaText) {
        alert('Wrong captcha!');
        generateCaptcha();
        return;
      }

      if (users.find(u => u.email === email)) {
        alert('Email already registered!');
        return;
      }

      const levelRadio = document.querySelector('input[name="applicantLevel"]:checked');
      if (!levelRadio) {
        alert('Please select applicant level!');
        return;
      }

      const applicantLevel = levelRadio.value;
      let gradeLevel = '';
      let strand = 'N/A';
      
      if (applicantLevel === 'Junior High School') {
        gradeLevel = document.getElementById('jhsGrade').value;
        if (!gradeLevel) {
          alert('Please select grade level!');
          return;
        }
      } else {
        gradeLevel = document.getElementById('shsGrade').value;
        strand = document.getElementById('strand').value;
        if (!gradeLevel || !strand) {
          alert('Please select grade level and strand!');
          return;
        }
      }

      const statusRadio = document.querySelector('input[name="studentStatus"]:checked');
      if (!statusRadio) {
        alert('Please select student status!');
        return;
      }

      const password = generatePassword();
      const userId = 'TNHS' + Date.now();
      
      // Assign section immediately upon registration
      const assignedSection = assignSection(parseInt(gradeLevel), strand);
      
      const newUser = {
        userId: userId,
        lrn: document.getElementById('lrn').value,
        email: email,
        password: password,
        firstName: document.getElementById('firstName').value,
        middleName: document.getElementById('middleName').value,
        lastName: document.getElementById('lastName').value,
        contact: document.getElementById('contact').value,
        applicantLevel: applicantLevel,
        gradeLevel: parseInt(gradeLevel),
        studentStatus: statusRadio.value,
        lastSchool: document.getElementById('lastSchool').value || '',
        strand: strand,
        section: assignedSection,
        sf1Submitted: false,
        sf1Data: {}
      };

      users.push(newUser);
      saveUsersToStorage();
      document.getElementById('modalEmail').textContent = email;
      document.getElementById('modalPassword').textContent = password;
      document.getElementById('modalUserId').textContent = userId;
      
      // Remove any existing section info from modal
      const credentialsDiv = document.querySelector('.credentials');
      const existingSection = credentialsDiv.querySelector('.section-info');
      if (existingSection) {
        existingSection.remove();
      }
      
      document.getElementById('successModal').style.display = 'block';
      this.reset();
      document.getElementById('jhsOptions').style.display = 'none';
      document.getElementById('shsOptions').style.display = 'none';
      document.getElementById('lastSchoolDiv').style.display = 'none';
    });

    document.getElementById('loginForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      const user = users.find(u => u.email === email && u.password === password);

      if (user) {
        currentUser = user;
        document.getElementById('userEmailDisplay').textContent = user.email;
        document.getElementById('errorMessage').style.display = 'none';
        
        if (user.sf1Submitted) {
          // Show success message with section after SF1 is completed
          document.getElementById('successMessage').style.display = 'block';
          document.getElementById('sf1Form').style.display = 'none';
          if (user.section) {
            document.getElementById('sectionDisplay').textContent = `You have been assigned to Section: ${user.section}`;
            document.getElementById('sectionDisplay').style.display = 'block';
          }
        } else {
          // Don't show section until SF1 is completed
          document.getElementById('successMessage').style.display = 'none';
          document.getElementById('sf1Form').style.display = 'block';
          document.getElementById('sectionDisplay').style.display = 'none';
        }
        showPage('sf1Page');
        this.reset();
      } else {
        document.getElementById('errorMessage').style.display = 'block';
      }
    });

    document.getElementById('sf1Form').addEventListener('submit', function(e) {
      e.preventDefault();
      if (!currentUser) {
        alert('Session expired!');
        showPage('loginPage');
        return;
      }

      // Collect all SF1 form data
      const formData = new FormData(this);
      const sf1Data = {};
      for (let [key, value] of formData.entries()) {
        sf1Data[key] = value;
      }

      // Add radio button values
      sf1Data.gender = document.querySelector('input[name="gender"]:checked')?.value || '';
      sf1Data.indigenous = document.querySelector('input[name="indigenous"]:checked')?.value || 'No';
      sf1Data.specialNeeds = document.querySelector('input[name="specialNeeds"]:checked')?.value || 'No';
      sf1Data.vaccinated = document.querySelector('input[name="vaccinated"]:checked')?.value || 'No';

      // Add checkbox values
      sf1Data.isCCT = document.querySelector('input[name="isCCT"]').checked ? 'Yes' : 'No';

      currentUser.sf1Data = sf1Data;
      currentUser.sf1Submitted = true;

      // Store gender in user object for easy access
      currentUser.gender = sf1Data.gender;

      // Section is already assigned during registration, just display it
      document.getElementById('successMessage').style.display = 'block';
      document.getElementById('sf1Form').style.display = 'none';
      
      if (currentUser.section) {
        document.getElementById('sectionDisplay').textContent = `You have been assigned to Section: ${currentUser.section}`;
        document.getElementById('sectionDisplay').style.display = 'block';
      }
      renderAdminTable();
      window.scrollTo(0, 0);
    });

    document.getElementById('sameAsCurrentAddress').addEventListener('change', function() {
      if (this.checked) {
        const current = {
          province: document.querySelector('[name="currentProvince"]').value,
          city: document.querySelector('[name="currentCity"]').value,
          zip: document.querySelector('[name="currentZip"]').value,
          barangay: document.querySelector('[name="currentBarangay"]').value
        };
        document.querySelector('[name="permanentProvince"]').value = current.province;
        document.querySelector('[name="permanentCity"]').value = current.city;
        document.querySelector('[name="permanentZip"]').value = current.zip;
        document.querySelector('[name="permanentBarangay"]').value = current.barangay;
      } else {
        document.querySelector('[name="permanentProvince"]').value = '';
        document.querySelector('[name="permanentCity"]').value = '';
        document.querySelector('[name="permanentZip"]').value = '';
        document.querySelector('[name="permanentBarangay"]').value = '';
      }
    });

    let editingUserId = null;

    function openSectionModal(userId) {
      const user = users.find(u => u.userId === userId);
      if (!user) return;
      
      editingUserId = userId;
      document.getElementById('editStudentName').textContent = `${user.firstName} ${user.lastName}`;
      document.getElementById('editCurrentSection').textContent = user.section || 'Not Assigned';
      
      const select = document.getElementById('newSectionSelect');
      select.innerHTML = '<option value="">-- Select Section --</option>';
      
      if (user.applicantLevel === 'Senior High School' && user.strand !== 'N/A') {
        const key = `g${user.gradeLevel}-${user.strand}`;
        const config = sectionCapacity[key];
        
        if (config) {
          config.sections.forEach(section => {
            const option = document.createElement('option');
            option.value = section;
            option.textContent = section;
            select.appendChild(option);
          });
        }
      } else if (user.applicantLevel === 'Junior High School') {
        for (let i = 1; i <= 5; i++) {
          const option = document.createElement('option');
          option.value = `Section ${i}`;
          option.textContent = `Section ${i}`;
          select.appendChild(option);
        }
      }
      
      document.getElementById('sectionModal').style.display = 'block';
    }

    function closeSectionModal() {
      document.getElementById('sectionModal').style.display = 'none';
      editingUserId = null;
    }

    function confirmSectionChange() {
      const newSection = document.getElementById('newSectionSelect').value;
      
      if (!newSection) {
        alert('Please select a section!');
        return;
      }
      
      const user = users.find(u => u.userId === editingUserId);
      if (user) {
        user.section = newSection;
        closeSectionModal();
        renderAdminTable();
        alert('Section updated successfully!');
      }
    }

    window.onload = function() {
      generateCaptcha();
    };

    // Download Modal Functions
    let selectedSections = new Set();

    function openDownloadModal() {
      if (users.length === 0) {
        alert('No student data available to download!');
        return;
      }

      // Group students by section
      const sectionGroups = {};
      
      users.forEach(user => {
        const sectionKey = user.section || 'Unassigned';
        const gradeStrand = user.strand === 'N/A' 
          ? `Grade ${user.gradeLevel}` 
          : `Grade ${user.gradeLevel} - ${user.strand}`;
        const fullKey = `${gradeStrand} - ${sectionKey}`;
        
        if (!sectionGroups[fullKey]) {
          sectionGroups[fullKey] = {
            students: [],
            gradeLevel: user.gradeLevel,
            strand: user.strand,
            section: sectionKey
          };
        }
        sectionGroups[fullKey].students.push(user);
      });

      // Build section list
      const container = document.getElementById('sectionListContainer');
      container.innerHTML = '';
      
      Object.keys(sectionGroups).sort().forEach(sectionKey => {
        const group = sectionGroups[sectionKey];
        const count = group.students.length;
        
        const sectionItem = document.createElement('div');
        sectionItem.className = 'section-item';
        sectionItem.dataset.sectionKey = sectionKey;
        sectionItem.innerHTML = `
          <div class="section-item-title">${sectionKey}</div>
          <div class="section-item-count">${count} student${count !== 1 ? 's' : ''}</div>
        `;
        
        sectionItem.onclick = () => toggleSectionSelection(sectionKey, sectionItem);
        container.appendChild(sectionItem);
      });

      selectedSections.clear();
      updateDownloadButton();
      document.getElementById('downloadModal').style.display = 'block';
    }

    function closeDownloadModal() {
      document.getElementById('downloadModal').style.display = 'none';
      selectedSections.clear();
    }

    function toggleSectionSelection(sectionKey, element) {
      if (selectedSections.has(sectionKey)) {
        selectedSections.delete(sectionKey);
        element.classList.remove('selected');
      } else {
        selectedSections.add(sectionKey);
        element.classList.add('selected');
      }
      updateDownloadButton();
    }

    function toggleSelectAll() {
      const allItems = document.querySelectorAll('.section-item');
      
      if (selectedSections.size === allItems.length) {
        // Deselect all
        selectedSections.clear();
        allItems.forEach(item => item.classList.remove('selected'));
      } else {
        // Select all
        allItems.forEach(item => {
          const sectionKey = item.dataset.sectionKey;
          selectedSections.add(sectionKey);
          item.classList.add('selected');
        });
      }
      updateDownloadButton();
    }

    function updateDownloadButton() {
      const btn = document.getElementById('downloadBtn');
      const countSpan = document.getElementById('selectedCount');
      
      countSpan.textContent = selectedSections.size;
      btn.disabled = selectedSections.size === 0;
    }

    function downloadSelectedSections() {
      if (selectedSections.size === 0) {
        alert('Please select at least one section to download!');
        return;
      }

      const headers = [
        'Student ID', 'LRN', 'First Name', 'Middle Name', 'Last Name', 'Gender',
        'Email', 'Contact Number', 'Applicant Level', 'Grade Level', 'Strand', 'Section',
        'Student Status', 'Last School Attended', 'SF1 Status',
        'Guardian First Name', 'Guardian Middle Name', 'Guardian Last Name', 'Guardian Extension', 'Guardian Relationship',
        'Mother First Name', 'Mother Middle Name', 'Mother Last Name', 'Mother Extension',
        'Father First Name', 'Father Middle Name', 'Father Last Name', 'Father Extension',
        'Indigenous Peoples Member', 'Ethnicity', 'Mother Tongue', 'Religion', 'Other Languages',
        'Current Province', 'Current City', 'Current Barangay', 'Current Zip Code',
        'Permanent Province', 'Permanent City', 'Permanent Barangay', 'Permanent Zip Code',
        'Citizenship', 'CCT Recipient', 'Special Educational Needs', 'LSEN Type',
        'COVID-19 Vaccinated', 'Learning Modality'
      ];

      const dateStamp = new Date().toISOString().split('T')[0];
      let downloadCount = 0;

      selectedSections.forEach(sectionKey => {
        // Filter students for this section
        const sectionStudents = users.filter(user => {
          const userSectionKey = user.strand === 'N/A' 
            ? `Grade ${user.gradeLevel} - ${user.section || 'Unassigned'}`
            : `Grade ${user.gradeLevel} - ${user.strand} - ${user.section || 'Unassigned'}`;
          return userSectionKey === sectionKey;
        });

        if (sectionStudents.length === 0) return;

        // Sort students: Female first, then Male, then by last name
        const sortedStudents = [...sectionStudents].sort((a, b) => {
          const genderA = a.gender || 'N/A';
          const genderB = b.gender || 'N/A';
          if (genderA !== genderB) {
            if (genderA === 'Female') return -1;
            if (genderB === 'Female') return 1;
            if (genderA === 'Male') return -1;
            if (genderB === 'Male') return 1;
          }
          // Finally by last name alphabetically
          return (a.lastName || '').localeCompare(b.lastName || '');
        });

        // Build CSV content
        let csvContent = headers.join(',') + '\n';

        sortedStudents.forEach(user => {
          const sf1 = user.sf1Data || {};
          const row = [
            user.userId || '', user.lrn || '', user.firstName || '', user.middleName || '', user.lastName || '',
            user.gender || '', user.email || '', user.contact || '', user.applicantLevel || '',
            user.gradeLevel || '', user.strand || '', user.section || 'Not Assigned',
            user.studentStatus || '', user.lastSchool || '', user.sf1Submitted ? 'Completed' : 'Pending',
            sf1.guardianFirstName || '', sf1.guardianMiddleName || '', sf1.guardianLastName || '',
            sf1.guardianExtension || '', sf1.guardianRelationship || '',
            sf1.motherFirstName || '', sf1.motherMiddleName || '', sf1.motherLastName || '', sf1.motherExtension || '',
            sf1.fatherFirstName || '', sf1.fatherMiddleName || '', sf1.fatherLastName || '', sf1.fatherExtension || '',
            sf1.indigenous || '', sf1.ethnicity || '', sf1.motherTongue || '', sf1.religion || '', sf1.otherLanguages || '',
            sf1.currentProvince || '', sf1.currentCity || '', sf1.currentBarangay || '', sf1.currentZip || '',
            sf1.permanentProvince || '', sf1.permanentCity || '', sf1.permanentBarangay || '', sf1.permanentZip || '',
            sf1.citizenship || '', sf1.isCCT || '', sf1.specialNeeds || '', sf1.lsenType || '',
            sf1.vaccinated || '', sf1.modality || ''
          ];

          const escapedRow = row.map(field => {
            const stringField = String(field);
            if (stringField.includes(',') || stringField.includes('"') || stringField.includes('\n')) {
              return '"' + stringField.replace(/"/g, '""') + '"';
            }
            return stringField;
          });

          csvContent += escapedRow.join(',') + '\n';
        });

        // Create download
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        
        const fileName = `TNHS_${sectionKey.replace(/\s+/g, '_')}_${dateStamp}.csv`;
        link.setAttribute('href', url);
        link.setAttribute('download', fileName);
        link.style.visibility = 'hidden';
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        downloadCount++;
      });

      closeDownloadModal();
      alert(`Successfully downloaded ${downloadCount} file(s)!\n\nEach file is organized by:\n- Gender (Female â†’ Male)\n- Last Name (A-Z)`);
    }

    function downloadAllData() {
      if (users.length === 0) {
        alert('No student data available to download!');
        return;
      }

      const headers = [
        'Student ID', 'LRN', 'First Name', 'Middle Name', 'Last Name', 'Gender',
        'Email', 'Contact Number', 'Applicant Level', 'Grade Level', 'Strand', 'Section',
        'Student Status', 'Last School Attended', 'SF1 Status',
        'Guardian First Name', 'Guardian Middle Name', 'Guardian Last Name', 'Guardian Extension', 'Guardian Relationship',
        'Mother First Name', 'Mother Middle Name', 'Mother Last Name', 'Mother Extension',
        'Father First Name', 'Father Middle Name', 'Father Last Name', 'Father Extension',
        'Indigenous Peoples Member', 'Ethnicity', 'Mother Tongue', 'Religion', 'Other Languages',
        'Current Province', 'Current City', 'Current Barangay', 'Current Zip Code',
        'Permanent Province', 'Permanent City', 'Permanent Barangay', 'Permanent Zip Code',
        'Citizenship', 'CCT Recipient', 'Special Educational Needs', 'LSEN Type',
        'COVID-19 Vaccinated', 'Learning Modality'
      ];

      // Sort all students: by grade, strand, section, gender (Female first), then last name
      const sortedStudents = [...users].sort((a, b) => {
        // First by grade level
        if (a.gradeLevel !== b.gradeLevel) {
          return a.gradeLevel - b.gradeLevel;
        }
        // Then by strand
        if (a.strand !== b.strand) {
          return a.strand.localeCompare(b.strand);
        }
        // Then by section
        if ((a.section || '') !== (b.section || '')) {
          return (a.section || '').localeCompare(b.section || '');
        }
        // Then by gender (Female first, then Male)
        const genderA = a.gender || 'N/A';
        const genderB = b.gender || 'N/A';
        if (genderA !== genderB) {
          if (genderA === 'Female') return -1;
          if (genderB === 'Female') return 1;
          if (genderA === 'Male') return -1;
          if (genderB === 'Male') return 1;
        }
        // Finally by last name
        return (a.lastName || '').localeCompare(b.lastName || '');
      });

      // Build CSV content
      let csvContent = headers.join(',') + '\n';

      sortedStudents.forEach(user => {
        const sf1 = user.sf1Data || {};
        const row = [
          user.userId || '', user.lrn || '', user.firstName || '', user.middleName || '', user.lastName || '',
          user.gender || '', user.email || '', user.contact || '', user.applicantLevel || '',
          user.gradeLevel || '', user.strand || '', user.section || 'Not Assigned',
          user.studentStatus || '', user.lastSchool || '', user.sf1Submitted ? 'Completed' : 'Pending',
          sf1.guardianFirstName || '', sf1.guardianMiddleName || '', sf1.guardianLastName || '',
          sf1.guardianExtension || '', sf1.guardianRelationship || '',
          sf1.motherFirstName || '', sf1.motherMiddleName || '', sf1.motherLastName || '', sf1.motherExtension || '',
          sf1.fatherFirstName || '', sf1.fatherMiddleName || '', sf1.fatherLastName || '', sf1.fatherExtension || '',
          sf1.indigenous || '', sf1.ethnicity || '', sf1.motherTongue || '', sf1.religion || '', sf1.otherLanguages || '',
          sf1.currentProvince || '', sf1.currentCity || '', sf1.currentBarangay || '', sf1.currentZip || '',
          sf1.permanentProvince || '', sf1.permanentCity || '', sf1.permanentBarangay || '', sf1.permanentZip || '',
          sf1.citizenship || '', sf1.isCCT || '', sf1.specialNeeds || '', sf1.lsenType || '',
          sf1.vaccinated || '', sf1.modality || ''
        ];

        const escapedRow = row.map(field => {
          const stringField = String(field);
          if (stringField.includes(',') || stringField.includes('"') || stringField.includes('\n')) {
            return '"' + stringField.replace(/"/g, '""') + '"';
          }
          return stringField;
        });

        csvContent += escapedRow.join(',') + '\n';
      });

      // Create download link
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      const dateStamp = new Date().toISOString().split('T')[0];
      
      link.setAttribute('href', url);
      link.setAttribute('download', `TNHS_Student_Data_${new Date().toISOString().split('T')[0]}.csv`);
      link.style.visibility = 'hidden';
      
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      closeDownloadModal();
      alert(`Successfully downloaded all student data!\n\nTotal: ${users.length} student(s)\n\nFile is organized by:\n- Grade Level\n- Strand\n- Section\n- Gender (Female â†’ Male)\n- Last Name (A-Z)`);
    }
  </script>

  <div id="sf1ViewModal" class="sf1-modal">
    <div class="sf1-modal-content" id="sf1ModalContent">
      <!-- SF1 data will be dynamically inserted here -->
    </div>
  </div>
</body>
</html>